<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Viewport crítico para móvil -->
    <title>Descargas - AGDP</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root {
            /* Colores Base (Modo Claro) */
            --primary: #204B42; 
            --primary-hover: #163630;
            --secondary: #64748b;
            
            --bg-body: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            
            --text-main: #0f172a;
            --text-light: #64748b;
            
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6; 
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);

            --input-bg: #ffffff;
        }

        /* --- MODO OSCURO --- */
        body.dark-mode {
            --primary: #2d6a5e;
            --primary-hover: #204B42;
            
            --bg-body: #0f172a;       
            --surface: #1e293b;       
            --border: #334155;        
            
            --text-main: #f1f5f9;     
            --text-light: #94a3b8;    
            
            --input-bg: #0f172a;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Desktop: App mode (fixed height) */
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- Header --- */
        header {
            background-color: #204B42; 
            padding: 0.5rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
            z-index: 20;
            color: white;
            flex-shrink: 0; 
        }

        .brand { display: flex; align-items: center; gap: 1rem; }
        
        .brand-logo {
            height: 40px; width: auto; object-fit: contain;
            background: white; padding: 2px 5px; border-radius: 4px;
        }

        .brand h1 { font-size: 1.1rem; font-weight: 600; color: white; margin: 0; white-space: nowrap; }
        
        .header-actions { display: flex; gap: 0.75rem; align-items: center; }

        .nav-icon-btn {
            background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); color: white;
            width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .nav-icon-btn:hover { background: rgba(255,255,255,0.3); }

        .user-profile {
            display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem;
            color: #204B42; background: white; padding: 0.3rem 0.8rem;
            border-radius: 999px; cursor: pointer; transition: transform 0.2s;
            font-weight: 600; box-shadow: var(--shadow-sm);
        }
        .user-profile:hover { transform: translateY(-1px); }

        /* --- Dashboard --- */
        .dashboard {
            flex: 1; display: flex; flex-direction: column; padding: 1rem; gap: 1rem; 
            overflow-y: auto; /* Desktop: Internal scroll */
            overflow-x: hidden;
        }

        /* KPI */
        .kpi-container {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;
            flex-shrink: 0;
        }
        .kpi-card {
            background: var(--surface); padding: 0.75rem 1rem; border-radius: 0.5rem;
            border: 1px solid var(--border); box-shadow: var(--shadow-sm);
            display: flex; flex-direction: column; justify-content: center;
        }
        .kpi-label { font-size: 0.7rem; text-transform: uppercase; font-weight: 600; color: var(--text-light); margin-bottom: 0.25rem; }
        .kpi-value { font-size: 1.25rem; font-weight: 700; color: var(--text-main); letter-spacing: -0.02em; }

        /* Controls */
        .controls-container {
            background-color: var(--surface); padding: 0.75rem; border-radius: 0.5rem;
            border: 1px solid var(--border); box-shadow: var(--shadow-sm);
            display: flex; flex-direction: column; gap: 0.75rem; z-index: 10;
            flex-shrink: 0;
        }
        .filters-row { display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; }

        /* Custom Dropdown */
        .custom-select-wrapper { position: relative; min-width: 130px; flex-grow: 1; }
        .custom-select-trigger {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.4rem 0.75rem; font-size: 0.8rem; 
            background: var(--input-bg); border: 1px solid var(--border); 
            border-radius: 0.375rem; cursor: pointer; transition: all 0.2s; 
            color: var(--text-light); white-space: nowrap; overflow: hidden;
        }
        .custom-select-trigger span { text-overflow: ellipsis; overflow: hidden; }
        .custom-select-trigger:hover { border-color: var(--primary); color: var(--text-main); }
        .group-by-wrapper .custom-select-trigger { 
            background-color: var(--surface); 
            border-color: var(--success); 
            color: var(--success); 
            font-weight: 600; 
        }
        body.dark-mode .group-by-wrapper .custom-select-trigger {
            background-color: #064e3b; 
            border-color: #059669;
            color: #6ee7b7;
        }
        
        .custom-options {
            position: absolute; top: 100%; left: 0; right: 0; 
            background: var(--surface); border: 1px solid var(--border); 
            border-radius: 0.375rem; margin-top: 4px;
            box-shadow: var(--shadow-md); display: none; z-index: 30; 
            max-height: 250px; overflow-y: auto; padding: 0.5rem;
        }
        .custom-options.open { display: block; }
        .option-item {
            display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem;
            cursor: pointer; border-radius: 0.25rem; font-size: 0.8rem; color: var(--text-main);
        }
        .option-item:hover { background-color: var(--bg-body); }

        /* Inputs & Buttons */
        .search-input-wrapper { position: relative; min-width: 160px; flex-grow: 1; }
        .search-input {
            width: 100%; padding: 0.4rem 0.75rem 0.4rem 2rem; font-size: 0.8rem;
            border: 1px solid var(--border); border-radius: 0.375rem; 
            font-family: 'Inter', sans-serif; transition: all 0.2s;
            background: var(--input-bg); color: var(--text-main);
        }
        .search-input:focus { outline: none; border-color: var(--primary); }
        .search-icon { position: absolute; left: 0.6rem; top: 50%; transform: translateY(-50%); color: var(--text-light); }

        /* Date Inputs */
        .date-input-wrapper { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; color: var(--text-light); }
        .date-input {
            padding: 0.4rem; border: 1px solid var(--border); border-radius: 0.375rem; 
            font-family: 'Inter', sans-serif; font-size: 0.8rem;
            background: var(--input-bg); color: var(--text-main);
            color-scheme: light; width: 100%;
        }
        body.dark-mode .date-input { color-scheme: dark; }

        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.4rem 0.8rem;
            border-radius: 0.375rem; font-size: 0.8rem; font-weight: 600; cursor: pointer;
            border: none; transition: background 0.2s; white-space: nowrap;
        }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-outline { background-color: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-outline:hover { background-color: var(--bg-body); border-color: var(--secondary); }
        .btn-icon { padding: 0.4rem; border-radius: 0.25rem; background: transparent; border: none; cursor: pointer; color: var(--text-light); }
        .btn-icon:hover { background-color: var(--bg-body); color: var(--primary); }

        .btn-flash { color: var(--text-main); border: 1px solid var(--border); background: var(--surface); width: 180px; justify-content: center; }
        .btn-flash.active { color: white; border: 1px solid var(--primary); background: var(--primary); }

        .toggle-filter { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; color: var(--text-light); cursor: pointer; user-select: none; }

        /* --- Table --- */
        .table-container {
            flex: 1; background: var(--surface); border-radius: 0.5rem;
            border: 1px solid var(--border); box-shadow: var(--shadow-sm);
            overflow: auto; 
            position: relative;
            min-height: 0; 
        }
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.8rem; }
        thead { position: sticky; top: 0; z-index: 5; background-color: var(--bg-body); }
        th {
            text-align: left; padding: 0.75rem 1rem; font-weight: 600; color: var(--text-light);
            border-bottom: 1px solid var(--border); white-space: nowrap; background-color: var(--bg-body);
        }
        td {
            padding: 0.6rem 1rem; border-bottom: 1px solid var(--border);
            color: var(--text-main); white-space: nowrap; vertical-align: middle;
        }
        th.text-right, td.text-right { text-align: right; }
        tbody tr:hover { background-color: var(--bg-body); }
        
        .row-grouped { background-color: #f0fdf4; font-weight: 600; color: #166534; }
        body.dark-mode .row-grouped { background-color: #064e3b; color: #6ee7b7; }
        
        .checkbox-cell { width: 30px; text-align: center; }
        .col-tight { width: 1%; white-space: nowrap; padding-left: 0.5rem; padding-right: 0.5rem; }

        .map-trigger {
            color: var(--primary); cursor: pointer; padding: 4px; border-radius: 4px;
            transition: background 0.2s; display: inline-flex;
        }
        .map-trigger:hover { background-color: var(--bg-body); }

        .val-badge {
            cursor: pointer; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; display: inline-block;
        }
        .val-ok { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .val-no { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        
        body.dark-mode .val-ok { background: #065f46; color: #a7f3d0; border-color: #047857; }
        body.dark-mode .val-no { background: #7f1d1d; color: #fecaca; border-color: #991b1b; }

        .col-config-wrapper { position: relative; min-width: auto !important; width: auto; }
        .col-config-btn { 
            padding: 0.4rem; min-width: 32px; width: 32px; height: 32px; 
            display: flex; align-items: center; justify-content: center;
        }

        .mass-action-bar {
            background-color: var(--surface); color: var(--text-main); padding: 0.5rem 1rem;
            border-radius: 0.5rem; display: flex; align-items: center; gap: 1rem;
            font-size: 0.85rem; margin-left: auto;
            border: 1px solid var(--border); box-shadow: var(--shadow-lg);
            opacity: 0; pointer-events: none; transition: opacity 0.2s, transform 0.2s;
            transform: translateY(10px);
        }
        .mass-action-bar.visible { opacity: 1; pointer-events: all; transform: translateY(0); }

        /* --- MEDIA QUERIES (Mobile Optimization FIXED) --- */
        @media (max-width: 768px) {
            /* 1. Liberar el scroll de la página completa */
            body {
                height: auto; 
                overflow-y: auto; 
            }
            
            /* 2. El Dashboard no se ajusta al alto, crece con el contenido */
            .dashboard {
                height: auto;
                overflow: visible;
                display: block; 
            }

            header { padding: 0.5rem 1rem; }
            .brand h1 { display: none; }
            .header-actions { gap: 0.5rem; }
            .user-profile span { display: none; }
            .user-profile { padding: 0.4rem; }

            .kpi-container { grid-template-columns: 1fr 1fr; gap: 0.5rem; }
            .kpi-card { padding: 0.75rem; }
            .kpi-value { font-size: 1.1rem; }

            .controls-container { padding: 0.75rem; }
            .filters-row { gap: 0.75rem; }
            
            .custom-select-wrapper, .search-input-wrapper, .date-input-wrapper { width: 100%; }
            .date-input-wrapper { flex-direction: column; align-items: flex-start; gap: 0.2rem; }
            
            .filters-row > div:last-child { 
                flex-direction: column; width: 100%; align-items: stretch; margin-left: 0;
            }
            .filters-row:last-child {
                flex-direction: column;
                align-items: stretch;
            }
            .filters-row:last-child > div {
                flex-direction: column;
                align-items: stretch;
                width: 100%;
                margin: 0;
            }
            .btn, .btn-flash { width: 100%; }
            .col-config-wrapper { display: none; }
            
            .mass-action-bar {
                position: fixed; bottom: 20px; left: 5%; right: 5%; width: 90%;
                justify-content: space-between; z-index: 100;
                transform: translateY(150%);
            }
            .mass-action-bar.visible { transform: translateY(0); }

            /* 3. La tabla tiene su propia altura para scroll interno */
            .table-container {
                flex: none; /* No usar flex grow */
                height: 500px; /* Altura fija generosa */
                min-height: 500px;
                overflow-x: auto; /* Scroll horizontal habilitado */
                overflow-y: auto; /* Scroll vertical dentro de la tabla */
            }
        }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center;
            align-items: center; z-index: 1000; opacity: 0; pointer-events: none;
            transition: opacity 0.2s; backdrop-filter: blur(2px);
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        
        .modal-card {
            background: var(--surface); width: 90%; max-width: 1000px; height: 85vh;
            border-radius: 0.75rem; display: flex; flex-direction: column;
            overflow: hidden; box-shadow: var(--shadow-lg); color: var(--text-main);
        }

        #google-map-container { width: 100%; height: 100%; background: #e2e8f0; }

        .modal-sm { max-width: 500px; height: auto; max-height: 90vh; overflow-y: auto; }
        .modal-lg { max-width: 900px; height: auto; max-height: 90vh; overflow-y: auto; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; padding: 1.5rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .form-group.full-width { grid-column: span 2; }
        .form-label { font-size: 0.8rem; font-weight: 600; color: var(--text-light); }
        .form-input, .form-select {
            padding: 0.5rem; border: 1px solid var(--border); border-radius: 0.375rem;
            font-family: 'Inter', sans-serif; font-size: 0.9rem;
            background: var(--input-bg); color: var(--text-main);
        }
        .form-input:disabled { background-color: var(--bg-body); color: var(--text-light); cursor: not-allowed; }
        .modal-footer {
            padding: 1rem 1.5rem; border-top: 1px solid var(--border); background-color: var(--bg-body);
            display: flex; justify-content: flex-end; gap: 0.75rem;
        }
        .section-title {
            grid-column: span 2; font-size: 0.9rem; font-weight: 600; color: var(--primary);
            border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .form-group.full-width { grid-column: span 1; }
        }

        .preview-grid-wrapper {
            grid-column: span 2; border: 1px solid var(--border);
            border-radius: 0.375rem; overflow-x: auto; max-height: 250px; margin-bottom: 1rem;
        }
        .preview-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .preview-table th { background: var(--bg-body); color: var(--text-light); padding: 0.5rem; text-align: left; font-weight: 600; position: sticky; top: 0; }
        .preview-table td { padding: 0.5rem; border-bottom: 1px solid var(--border); color: var(--text-main); }
        .preview-change { color: var(--primary); font-weight: bold; background-color: rgba(32, 75, 66, 0.1); }

    </style>
</head>
<body>

    <header>
        <div class="brand">
            <img src="LOGO_AGDP POWERED BY CORVUS.png" alt="Logo AGDP" class="brand-logo">
            <h1>Descargas <span style="font-weight: 400; font-size: 0.9em; opacity: 0.9;">| AGDP</span></h1>
        </div>
        
        <div class="header-actions">
            <button class="nav-icon-btn" onclick="toggleDarkMode()" title="Alternar Modo Oscuro">
                <i id="theme-icon" class="ph ph-moon" style="font-size: 1.2rem;"></i>
            </button>
            <button class="nav-icon-btn" onclick="openImportModal()" title="Importar Datos de Google Sheets">
                <i class="ph ph-cloud-arrow-down" style="font-size: 1.2rem;"></i>
            </button>
            <div class="user-profile" onclick="openProfileModal()" title="Editar Perfil">
                <i class="ph ph-user-circle" style="font-size: 1.25rem;"></i>
                <span id="header-username">Martin (Gerente)</span>
            </div>
        </div>
    </header>

    <div class="dashboard">
        
        <!-- KPI -->
        <section class="kpi-container">
            <div class="kpi-card"><div class="kpi-label">Total Kg Húmedo</div><div class="kpi-value" id="kpi-total-kg">0</div></div>
            <div class="kpi-card"><div class="kpi-label">Total Kg Seco</div><div class="kpi-value" id="kpi-total-sec">0</div></div>
            <div class="kpi-card"><div class="kpi-label">Registros / Grupos</div><div class="kpi-value" id="kpi-count">0</div></div>
            <div class="kpi-card"><div class="kpi-label">Promedio Kg</div><div class="kpi-value" id="kpi-avg">0</div></div>
        </section>

        <!-- Filters -->
        <section class="controls-container">
            <div class="filters-row">
                <div class="date-input-wrapper">
                    <span>Desde:</span>
                    <input type="date" id="filter-date-from" class="date-input" onchange="applyFilters()">
                </div>
                <div class="date-input-wrapper">
                    <span>Hasta:</span>
                    <input type="date" id="filter-date-to" class="date-input" onchange="applyFilters()">
                </div>

                <div class="custom-select-wrapper" id="filter-productor"><div class="custom-select-trigger"><span>Productor</span> <i class="ph ph-caret-down"></i></div><div class="custom-options"></div></div>
                <div class="custom-select-wrapper" id="filter-prod"><div class="custom-select-trigger"><span>Producto</span> <i class="ph ph-caret-down"></i></div><div class="custom-options"></div></div>
                <div class="custom-select-wrapper" id="filter-est"><div class="custom-select-trigger"><span>Establecimiento</span> <i class="ph ph-caret-down"></i></div><div class="custom-options"></div></div>
                <div class="custom-select-wrapper" id="filter-lote"><div class="custom-select-trigger"><span>Lote</span> <i class="ph ph-caret-down"></i></div><div class="custom-options"></div></div>
                <div class="custom-select-wrapper" id="filter-tolva"><div class="custom-select-trigger"><span>Tolva</span> <i class="ph ph-caret-down"></i></div><div class="custom-options"></div></div>
                
                <div class="search-input-wrapper">
                    <i class="ph ph-magnifying-glass search-icon"></i>
                    <input type="text" id="filter-destino-text" class="search-input" placeholder="Buscar Destino..." oninput="applyFilters()">
                </div>
                
                <label class="toggle-filter" title="Excluir descargas menores a 100kg">
                    <input type="checkbox" id="filter-hide-low" onchange="applyFilters()"> 
                    Ocultar < 100kg
                </label>
            </div>

            <div class="filters-row">
                <!-- Group By Wrapper -->
                <div style="display:flex; align-items: center; gap: 0.5rem; flex-wrap:wrap;">
                    <span style="font-size: 0.8rem; font-weight: 600; color: var(--text-light); text-transform: uppercase;">Agrupar:</span>
                    <div class="custom-select-wrapper group-by-wrapper" id="group-by-select">
                        <div class="custom-select-trigger"><span>(Sin Agrupar)</span> <i class="ph ph-stack"></i></div>
                        <div class="custom-options"></div>
                    </div>
                </div>

                <button class="btn btn-flash" id="btn-flash-toggle" onclick="toggleQuickGroup()">
                    <i class="ph ph-stack-plus"></i> Agrupar Destinos
                </button>

                <div id="mass-action-bar" class="mass-action-bar">
                    <span id="selected-count" style="font-weight: 600; color: var(--primary);">0 seleccionados</span>
                    <button class="btn btn-primary" style="padding: 0.3rem 0.8rem; font-size: 0.8rem;" onclick="openMassEditModal()">
                        <i class="ph ph-pencil-simple"></i> Editar Selección
                    </button>
                </div>

                <!-- Right Side Actions -->
                <div style="display:flex; gap: 0.5rem; align-items: center; margin-left: auto;">
                    <div class="custom-select-wrapper col-config-wrapper" id="col-config">
                        <div class="custom-select-trigger col-config-btn" title="Configurar Columnas">
                            <i class="ph ph-gear"></i>
                        </div>
                        <div class="custom-options" style="right: 0; left: auto; width: 200px;"></div>
                    </div>

                    <button class="btn btn-primary" onclick="openMapGlobal()"><i class="ph ph-map-trifold"></i> Ver Mapa Global</button>
                </div>
            </div>
        </section>

        <!-- Table -->
        <section class="table-container">
            <table id="main-table">
                <thead>
                    <tr id="table-header-row">
                        <!-- JS Injects Headers -->
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- JS Injects Rows -->
                </tbody>
            </table>
        </section>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="map-modal">
        <div class="modal-card">
            <div class="modal-header" style="padding: 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <h3>Geolocalización</h3>
                <button class="btn-icon" onclick="closeMap()"><i class="ph ph-x" style="font-size: 1.5rem;"></i></button>
            </div>
            <div style="flex: 1; position: relative;">
                <div id="google-map-container"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="import-modal">
        <div class="modal-card modal-sm">
            <div class="modal-header" style="padding: 1rem; border-bottom: 1px solid var(--border);">
                <h3>Conectar Google Sheets</h3>
            </div>
            <div class="form-grid" style="grid-template-columns: 1fr;">
                <p style="font-size:0.85rem; color: var(--text-light);">Ingrese el enlace público de la hoja de cálculo. Asegúrese de que esté configurada como "Cualquiera con el enlace puede ver".</p>
                <div class="form-group">
                    <label class="form-label">Enlace de Google Sheets</label>
                    <input type="text" id="sheet-url-input" class="form-input" placeholder="https://docs.google.com/spreadsheets/...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="document.getElementById('import-modal').classList.remove('active')">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmImport()">Cargar Datos</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="edit-modal">
        <div class="modal-card modal-sm">
            <div class="modal-header" style="padding: 1rem; border-bottom: 1px solid var(--border);">
                <h3>Modificar Descarga</h3>
            </div>
            <div class="form-grid">
                <input type="hidden" id="edit-index">
                <div class="form-group"><label class="form-label">Fecha</label><div class="lock-wrapper"><input type="text" id="edit-fecha" class="form-input" disabled style="width:100%"><button class="unlock-btn" onclick="unlockField('edit-fecha')"><i class="ph ph-lock-key"></i></button></div></div>
                <div class="form-group"><label class="form-label">Kg Húmedo</label><div class="lock-wrapper"><input type="text" id="edit-kg" class="form-input" disabled style="width:100%"><button class="unlock-btn" onclick="unlockField('edit-kg')"><i class="ph ph-lock-key"></i></button></div></div>
                <div class="form-group full-width"><label class="form-label">Establecimiento</label><select id="edit-est" class="form-select"></select></div>
                <div class="form-group"><label class="form-label">Lote</label><select id="edit-lote" class="form-select"></select></div>
                <div class="form-group"><label class="form-label">Producto</label><select id="edit-prod" class="form-select"></select></div>
                <div class="form-group full-width"><label class="form-label">Tolva</label><input type="text" id="edit-tolva" class="form-input"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeEditModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveEdit()">Guardar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="mass-edit-modal">
        <div class="modal-card modal-lg">
            <div class="modal-header" style="padding: 1rem; border-bottom: 1px solid var(--border);">
                <h3>Edición Múltiple</h3>
                <p style="font-size:0.8rem; color:var(--text-light)">Previsualice los cambios antes de confirmar.</p>
            </div>
            <div class="form-grid">
                <div class="preview-grid-wrapper">
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th>Establecimiento</th>
                                <th>Lote</th>
                                <th>Producto</th>
                                <th>Destino</th>
                                <th style="text-align:right;">Kg</th>
                            </tr>
                        </thead>
                        <tbody id="mass-preview-body"></tbody>
                    </table>
                </div>

                <div class="section-title" style="margin-top:0;">Nuevos Valores (Deje en blanco para no cambiar)</div>

                <div class="form-group"><label class="form-label">Establecimiento</label><select id="mass-est" class="form-select" onchange="updateMassPreview()"><option value="">(No cambiar)</option></select></div>
                <div class="form-group"><label class="form-label">Lote</label><select id="mass-lote" class="form-select" onchange="updateMassPreview()"><option value="">(No cambiar)</option></select></div>
                <div class="form-group"><label class="form-label">Producto</label><select id="mass-prod" class="form-select" onchange="updateMassPreview()"><option value="">(No cambiar)</option></select></div>
                <div class="form-group"><label class="form-label">Productor</label><select id="mass-productor" class="form-select" onchange="updateMassPreview()"><option value="">(No cambiar)</option></select></div>
                <div class="form-group"><label class="form-label">Destino</label><input type="text" id="mass-destino" class="form-input" placeholder="(No cambiar)" oninput="updateMassPreview()"></div>
                <div class="form-group"><label class="form-label">Carta Porte</label><input type="text" id="mass-cp" class="form-input" placeholder="(No cambiar)" oninput="updateMassPreview()"></div>
                
                <div class="form-group full-width">
                    <label class="form-label">Observación (Opcional)</label>
                    <input type="text" id="mass-obs" class="form-input" placeholder="Motivo de la edición...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="document.getElementById('mass-edit-modal').classList.remove('active')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveMassEdit()">Confirmar y Guardar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="profile-modal">
        <div class="modal-card modal-sm">
            <div class="modal-header" style="padding: 1rem; border-bottom: 1px solid var(--border);">
                <h3>Mi Perfil</h3>
            </div>
            <div class="form-grid">
                <div class="form-group"><label class="form-label">Nombre</label><input type="text" id="prof-name" class="form-input"></div>
                <div class="form-group"><label class="form-label">Apellido</label><input type="text" id="prof-lastname" class="form-input"></div>
                <div class="form-group"><label class="form-label">Email</label><input type="email" id="prof-email" class="form-input"></div>
                <div class="form-group"><label class="form-label">Teléfono</label><input type="text" id="prof-phone" class="form-input"></div>
                <div class="section-title">Cambiar Contraseña</div>
                <div class="form-group full-width"><label class="form-label">Clave Anterior</label><input type="password" id="prof-old-pass" class="form-input"></div>
                <div class="form-group"><label class="form-label">Nueva Clave</label><input type="password" id="prof-new-pass" class="form-input"></div>
                <div class="form-group"><label class="form-label">Confirmar</label><input type="password" id="prof-confirm-pass" class="form-input"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="document.getElementById('profile-modal').classList.remove('active')">Cerrar</button>
                <button class="btn btn-primary" onclick="saveProfile()">Guardar Perfil</button>
            </div>
        </div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBixHiS7Z6kVhh0tN7g9NdZaKrFxSji140&callback=initMap" async defer></script>

    <script>
        // --- CONFIG & STATE ---
        const DEFAULT_SHEET_URL = "https://docs.google.com/spreadsheets/d/1IDhJ8E7h5d7ezknTK-BaJkF66ydHAy4zZAv4FLl9u0k/edit?usp=sharing";

        let colConfig = {
            'STATUS': { label: 'Estado', visible: true, width: '50px' },
            'FECHA RECEPCION': { label: 'Fecha Recep', visible: true, dimensionKey: 'FECHA RECEPCION' },
            'HORA RECEPCION': { label: 'Hora Recep', visible: false, dimensionKey: 'HORA RECEPCION' }, 
            'PRODUCTOR': { label: 'Productor', visible: true, dimensionKey: 'PRODUCTOR' },
            'CONTRATISTA': { label: 'Contratista', visible: true, dimensionKey: 'CONTRATISTA' },
            'ESTABLECIMIENTO': { label: 'Establecimiento', visible: true, dimensionKey: 'ESTABLECIMIENTO' },
            'LOTE': { label: 'Lote', visible: true, dimensionKey: 'LOTE' },
            'PRODUCTO': { label: 'Producto', visible: true, dimensionKey: 'PRODUCTO' },
            'TOLVA': { label: 'Tolva', visible: true, dimensionKey: 'TOLVA' },
            'DESTINO DESCARGA': { label: 'Destino', visible: true, dimensionKey: 'DESTINO DESCARGA' },
            'CARTA DE PORTE': { label: 'Carta Porte', visible: true, dimensionKey: 'CARTA DE PORTE' },
            'VALIDACION': { label: 'Validación', visible: true, dimensionKey: 'VALIDACION' },
            'PESO_NUM': { label: 'Kg Húmedo', visible: true, align: 'right' },
            'ACTIONS': { label: '', visible: true, width: '1%' },
            'UBICACION': { label: 'Ubic.', visible: true, align: 'center', width: '1%' },
            'OBSERVACION': { label: 'Observación', visible: false }
        };

        let user = { name: "Martin", lastname: "Gerente", email: "martin@iso9001.com", phone: "123-4567", password: "123" };
        let state = {
            data: [], filtered: [], groupByKeys: [], isQuickGroupActive: false, selectedRows: new Set(),
            groupedData: [], currentSheetUrl: DEFAULT_SHEET_URL
        };
        let map; let mapMarkers = [];

        // --- DATA LOADING & PARSING ---
        async function loadSheetData(url) {
            const getExportUrl = (inputUrl) => {
                const match = inputUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
                if (match && match[1]) {
                    return `https://docs.google.com/spreadsheets/d/${match[1]}/export?format=csv`;
                }
                return inputUrl; 
            };
            const csvUrl = getExportUrl(url);
            try {
                document.getElementById('table-body').innerHTML = '<tr><td colspan="15" style="text-align:center; padding:2rem;">Cargando datos...</td></tr>';
                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error("Error de red al obtener datos");
                const csvText = await response.text();
                state.data = parseCSV(csvText);
                setDefaultDateFilters();
                state.filtered = [...state.data];
                initDropdown('filter-est', 'ESTABLECIMIENTO');
                initDropdown('filter-lote', 'LOTE');
                initDropdown('filter-prod', 'PRODUCTO');
                initDropdown('filter-productor', 'PRODUCTOR');
                initDropdown('filter-tolva', 'TOLVA');
                applyFilters();
            } catch (error) {
                console.error(error);
                document.getElementById('table-body').innerHTML = `<tr><td colspan="15" style="text-align:center; padding:2rem; color:red;">Error al cargar: ${error.message}. <br>Verifique que la hoja sea pública.</td></tr>`;
            }
        }

        // AUTO-DETECT DATE FORMAT (YYYY-MM-DD vs DD/MM/YYYY vs MM/DD/YYYY)
        function parseDateStrict(str) {
            if(!str) return null;
            const s = str.replace(/-/g, '/'); // Normalize
            const parts = s.split('/');
            if (parts.length !== 3) return null;
            
            let d, m, y;
            
            if (parts[0].length === 4) {
                // Case: YYYY/MM/DD
                y = parseInt(parts[0]);
                m = parseInt(parts[1]) - 1;
                d = parseInt(parts[2]);
            } else if (parts[2].length === 4) {
                // Case: DD/MM/YYYY or MM/DD/YYYY
                y = parseInt(parts[2]);
                const a = parseInt(parts[0]);
                const b = parseInt(parts[1]);
                
                // Heuristic to detect Day vs Month
                if (a > 12) {
                    // 26/11/2025 -> DD/MM
                    d = a; m = b - 1;
                } else if (b > 12) {
                    // 11/26/2025 -> MM/DD
                    m = a - 1; d = b;
                } else {
                    // Ambiguous (01/02/2025). Default to DD/MM (ES Standard)
                    d = a; m = b - 1;
                }
            } else {
                return null; 
            }
            
            const date = new Date(y, m, d);
            return isNaN(date.getTime()) ? null : date;
        }

        function setDefaultDateFilters() {
            if (state.data.length === 0) return;
            const dates = state.data.map(row => row.DATE_OBJ).filter(d => d);
            if (dates.length > 0) {
                const maxDate = new Date(Math.max.apply(null, dates));
                // Set Inputs (Requires YYYY-MM-DD)
                const y = maxDate.getFullYear();
                const m = String(maxDate.getMonth() + 1).padStart(2, '0');
                const d = String(maxDate.getDate()).padStart(2, '0');
                const ds = `${y}-${m}-${d}`;
                document.getElementById('filter-date-from').value = ds;
                document.getElementById('filter-date-to').value = ds;
            }
        }

        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            if(lines.length < 2) return [];
            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            return lines.slice(1).map((line, idx) => {
                const values = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                const fallbackValues = line.split(','); 
                const finalValues = (values.length >= headers.length) ? values : fallbackValues;
                const obj = { id: idx }; 
                headers.forEach((h, i) => {
                    let val = finalValues[i] ? finalValues[i].trim().replace(/^"|"$/g, '') : '';
                    obj[h] = val;
                });
                
                // DATA ENRICHMENT
                obj['PESO_NUM'] = parseFloat(obj['PESO HUMEDO Kg']) || 0;
                obj['PESO_SECO_NUM'] = parseFloat(obj['PESO SECO Kg']) || 0;
                
                // ROBUST DATE PARSING
                obj['DATE_OBJ'] = parseDateStrict(obj['FECHA RECEPCION']);
                // Generate Standardized String for Display (DD/MM/YYYY)
                if (obj['DATE_OBJ']) {
                    const dd = String(obj['DATE_OBJ'].getDate()).padStart(2, '0');
                    const mm = String(obj['DATE_OBJ'].getMonth() + 1).padStart(2, '0');
                    const yyyy = obj['DATE_OBJ'].getFullYear();
                    obj['FECHA RECEPCION'] = `${dd}/${mm}/${yyyy}`; // Overwrite with standardized format
                }

                obj['LAT_NUM'] = parseFloat(obj['LATITUD']);
                obj['LNG_NUM'] = parseFloat(obj['LONGITUD']);
                obj['GEO_POINT'] = (!isNaN(obj['LAT_NUM']) && !isNaN(obj['LNG_NUM'])) ? `${obj['LAT_NUM'].toFixed(4)}, ${obj['LNG_NUM'].toFixed(4)}` : '';
                
                const tipo = (obj['TIPO'] || '').toUpperCase();
                const isTipoEmpty = !obj['TIPO'] || obj['TIPO'].trim() === '';
                
                obj['IS_DEFECT'] = tipo.includes('DEFECTUOSA') || isTipoEmpty;
                obj['IS_MOD_WEB'] = tipo.includes('MODIFICADA') && !tipo.includes('TABLET');
                obj['IS_MOD_TABLET'] = tipo.includes('MODIFICADA TABLET');
                obj['IS_AUTO'] = tipo.includes('AUT') || obj['IS_MOD_WEB'] || obj['IS_MOD_TABLET']; 
                obj['IS_OVERWEIGHT'] = obj['PESO_NUM'] > 30000;
                obj['IS_VALID'] = (obj['VALIZACION'] && obj['VALIZACION'].toUpperCase() === 'TRUE');
                obj['AUTH_CODE'] = obj['AUTORIZACION CARGA'] || 'N/A';
                obj['OBSERVACION'] = ''; 
                return obj;
            });
        }

        function init() {
            loadSheetData(state.currentSheetUrl);
            initGroupByDropdown();
            initColumnConfig(); 
        }

        // --- FILTERS ---
        function applyFilters() {
            const getVals = id => Array.from(document.querySelectorAll(`#${id} input:checked`)).map(c => c.value);
            const fEst = getVals('filter-est');
            const fLote = getVals('filter-lote');
            const fProd = getVals('filter-prod');
            const fProductor = getVals('filter-productor');
            const fTolva = getVals('filter-tolva');
            const destQuery = document.getElementById('filter-destino-text').value.toLowerCase();
            const hideLow = document.getElementById('filter-hide-low').checked;
            
            // Filters use Start of Day and End of Day
            const dateFromInput = document.getElementById('filter-date-from').value;
            const dateToInput = document.getElementById('filter-date-to').value;
            const dateFrom = dateFromInput ? new Date(dateFromInput + 'T00:00:00') : null;
            const dateTo = dateToInput ? new Date(dateToInput + 'T23:59:59') : null;
            
            state.groupByKeys = Array.from(document.querySelectorAll(`#group-by-select input:checked`)).map(c => c.value);

            state.filtered = state.data.filter(r => {
                if (hideLow && r.PESO_NUM < 100) return false;
                
                if (dateFrom || dateTo) {
                    const rowDate = r.DATE_OBJ; // Use pre-parsed object
                    if (!rowDate) return false;
                    if (dateFrom && rowDate < dateFrom) return false;
                    if (dateTo && rowDate > dateTo) return false;
                }

                const matchEst = fEst.length === 0 || fEst.includes(r['ESTABLECIMIENTO']);
                const matchLote = fLote.length === 0 || fLote.includes(r['LOTE']);
                const matchProd = fProd.length === 0 || fProd.includes(r['PRODUCTO']);
                const matchProductor = fProductor.length === 0 || fProductor.includes(r['PRODUCTOR']);
                const matchTolva = fTolva.length === 0 || fTolva.includes(r['TOLVA']);
                const matchDest = !destQuery || r['DESTINO DESCARGA'].toLowerCase().includes(destQuery);
                return matchEst && matchLote && matchProd && matchProductor && matchTolva && matchDest;
            });
            updateUI();
        }

        // --- UI & RENDER ---
        function updateUI() {
            state.groupedData = processData();
            renderTableHeader();
            renderTable(state.groupedData);
            renderKPIs(state.groupedData);
            updateMassActionUI();
        }

        function renderTableHeader() {
            const tr = document.getElementById('table-header-row');
            tr.innerHTML = `<th class="checkbox-cell"><input type="checkbox" id="master-checkbox" onchange="toggleAllSelection()"></th>`;
            Object.keys(colConfig).forEach(key => {
                const conf = colConfig[key];
                let showColumn = conf.visible;
                if (state.groupByKeys.length > 0) {
                    const isSpecial = ['STATUS', 'PESO_NUM', 'ACTIONS', 'UBICACION'].includes(key);
                    const isInGroup = conf.dimensionKey && state.groupByKeys.includes(conf.dimensionKey);
                    if (!isSpecial && !isInGroup) showColumn = false;
                }
                if (showColumn) {
                    const style = conf.width ? `width: ${conf.width};` : '';
                    const align = conf.align ? `text-align: ${conf.align};` : '';
                    const classes = (key === 'ACTIONS' || key === 'UBICACION') ? 'col-tight' : '';
                    tr.innerHTML += `<th class="${classes}" style="${style} ${align}">${conf.label}</th>`;
                }
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            if (data.length === 0) {
                const colSpan = Object.values(colConfig).length + 1;
                tbody.innerHTML = `<tr><td colspan="${colSpan}" style="text-align:center; padding: 2rem; color: #64748b;">Sin resultados.</td></tr>`;
                return;
            }
            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                if (row.grouped) tr.classList.add('row-grouped');
                
                let checkHtml = '';
                if (!row.grouped) {
                    const isSelected = state.selectedRows.has(row.id);
                    checkHtml = `<input type="checkbox" onchange="toggleRowSelection(${row.id})" ${isSelected ? 'checked' : ''}>`;
                }
                let html = `<td class="checkbox-cell">${checkHtml}</td>`;

                Object.keys(colConfig).forEach(key => {
                    const conf = colConfig[key];
                    let showColumn = conf.visible;
                    if (state.groupByKeys.length > 0) {
                        const isSpecial = ['STATUS', 'PESO_NUM', 'ACTIONS', 'UBICACION'].includes(key);
                        const isInGroup = conf.dimensionKey && state.groupByKeys.includes(conf.dimensionKey);
                        if (!isSpecial && !isInGroup) showColumn = false;
                    }
                    if (!showColumn) return;
                    
                    let content = '';
                    let align = colConfig[key].align ? `text-align: ${colConfig[key].align};` : '';
                    let classes = '';

                    if (key === 'STATUS') {
                        if (row.grouped) content = `<span style="background:#dbeafe; padding:2px 6px; border-radius:4px; font-size:0.7rem; color:#1e40af; font-weight:bold;">${row.count} Regs</span>`;
                        else {
                            if (row.IS_DEFECT) content = `<i class="ph ph-warning-diamond" style="color:var(--danger); font-size: 1.2rem;" title="Defectuosa"></i>`;
                            else if (row.IS_OVERWEIGHT) content = `<i class="ph ph-warning" style="color:var(--warning); font-size: 1.2rem;" title="Sobrepeso"></i>`;
                            else if (row.IS_MOD_TABLET) content = `<i class="ph ph-pencil-simple" style="color:var(--info); font-size: 1.2rem;" title="Modificada Tablet"></i>`;
                            else if (row.IS_MOD_WEB) content = `<i class="ph ph-pencil-simple" style="color:var(--warning); font-size: 1.2rem;" title="Modificada Web"></i>`;
                            else if (row.IS_AUTO) content = `<i class="ph ph-check-circle" style="color:var(--success); font-size: 1.2rem;" title="Automática"></i>`;
                            else content = `<i class="ph ph-warning-circle" style="color:var(--warning); font-size: 1.2rem;" title="Manual"></i>`;
                        }
                        align = 'text-align: center;';
                    } 
                    else if (key === 'VALIDACION') {
                        if (row.grouped) content = '-';
                        else {
                            const cls = row.IS_VALID ? 'val-ok' : 'val-no';
                            const txt = row.IS_VALID ? 'Validada' : 'No Val.';
                            content = `<span class="val-badge ${cls}" onclick="alert('Código Autorización: ${row.AUTH_CODE}')">${txt}</span>`;
                        }
                    }
                    else if (key === 'ACTIONS') {
                        content = (!row.grouped) ? `<button class="btn-icon" onclick="openEditModal(${row.id})"><i class="ph ph-pencil-simple"></i></button>` : '';
                        align = 'text-align: center;'; classes = 'col-tight';
                    }
                    else if (key === 'UBICACION') {
                        if (row.grouped) content = `<div class="map-trigger" onclick="openMapGroup(${index})" title="Ver Mapa Grupo"><i class="ph ph-map-pin"></i></div>`;
                        else if (row.GEO_POINT) content = `<div class="map-trigger" onclick="openMapLocal(${row.LAT_NUM}, ${row.LNG_NUM})" title="Ver ubicación"><i class="ph ph-map-pin"></i></div>`;
                        align = 'text-align: center;'; classes = 'col-tight';
                    }
                    else if (key === 'PESO_NUM') { content = `<b>${row.PESO_NUM.toLocaleString('es-AR')}</b>`; }
                    else {
                        let val = row[key];
                        if (row.grouped) {
                            if (state.groupByKeys.includes(key)) content = `<strong>${val}</strong>`; else content = '-';
                        } else content = val || '-';
                    }
                    html += `<td class="${classes}" style="${align}">${content}</td>`;
                });
                tr.innerHTML = html; tbody.appendChild(tr);
            });
        }

        // --- GROUPING LOGIC ---
        function processData() {
            if (state.groupByKeys.length === 0) return state.filtered;
            const groups = {};
            state.filtered.forEach(row => {
                const groupKeyValues = state.groupByKeys.map(k => row[k]);
                const groupKey = groupKeyValues.join('|');
                if (!groups[groupKey]) {
                    groups[groupKey] = {
                        grouped: true, count: 0, PESO_NUM: 0, PESO_SECO_NUM: 0, items: [],
                        ...Object.fromEntries(state.groupByKeys.map(k => [k, row[k]])),
                        'FECHA RECEPCION': '-', 'HORA RECEPCION': '-', 'ESTABLECIMIENTO': '-', 
                        'LOTE': '-', 'PRODUCTO': '-', 'TOLVA': '-', 'DESTINO DESCARGA': '-', 
                        'CARTA DE PORTE': '-', 'VALIDACION': '-', 'GEO_POINT': '', 'OBSERVACION': '-',
                        'PRODUCTOR': '-', 'CONTRATISTA': '-'
                    };
                    state.groupByKeys.forEach(k => groups[groupKey][k] = row[k]);
                }
                groups[groupKey].PESO_NUM += row.PESO_NUM;
                groups[groupKey].PESO_SECO_NUM += row.PESO_SECO_NUM;
                groups[groupKey].count++;
                groups[groupKey].items.push(row); 
            });
            return Object.values(groups);
        }

        // --- HELPERS & MODALS ---
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const icon = document.getElementById('theme-icon');
            if (document.body.classList.contains('dark-mode')) {
                icon.classList.remove('ph-moon'); icon.classList.add('ph-sun');
            } else {
                icon.classList.remove('ph-sun'); icon.classList.add('ph-moon');
            }
        }
        function openImportModal() { document.getElementById('sheet-url-input').value = state.currentSheetUrl; document.getElementById('import-modal').classList.add('active'); }
        function confirmImport() { const url = document.getElementById('sheet-url-input').value.trim(); if(url) { state.currentSheetUrl = url; loadSheetData(url); document.getElementById('import-modal').classList.remove('active'); } }
        function renderKPIs(data) {
            const total = data.reduce((s, r) => s + r.PESO_NUM, 0);
            const totalSec = data.reduce((s, r) => s + r.PESO_SECO_NUM, 0);
            const avg = data.length > 0 ? total / data.length : 0;
            document.getElementById('kpi-total-kg').textContent = total.toLocaleString('es-AR');
            document.getElementById('kpi-total-sec').textContent = totalSec.toLocaleString('es-AR');
            document.getElementById('kpi-count').textContent = data.length;
            document.getElementById('kpi-avg').textContent = avg.toLocaleString('es-AR', {maximumFractionDigits: 0});
        }
        function initColumnConfig() {
            const wrapper = document.getElementById('col-config'); if(!wrapper) return;
            const opts = wrapper.querySelector('.custom-options'); const trigger = wrapper.querySelector('.custom-select-trigger');
            Object.keys(colConfig).forEach(key => {
                const conf = colConfig[key]; if(conf.label === '') return; 
                const d = document.createElement('div'); d.className = 'option-item';
                d.innerHTML = `<input type="checkbox" ${conf.visible ? 'checked' : ''}> ${conf.label}`;
                d.addEventListener('click', e => {
                    if(e.target.tagName !== 'INPUT') d.querySelector('input').checked = !d.querySelector('input').checked;
                    colConfig[key].visible = d.querySelector('input').checked; updateUI();
                }); opts.appendChild(d);
            });
            trigger.addEventListener('click', () => { document.querySelectorAll('.custom-options').forEach(o => o !== opts && o.classList.remove('open')); opts.classList.toggle('open'); });
        }
        function initDropdown(id, key) {
            const wrapper = document.getElementById(id); if (!wrapper) return; 
            const opts = wrapper.querySelector('.custom-options'); const trigger = wrapper.querySelector('.custom-select-trigger');
            opts.innerHTML = ''; 
            const vals = [...new Set(state.data.map(d => d[key]))].filter(Boolean).sort();
            vals.forEach(v => {
                const d = document.createElement('div'); d.className = 'option-item'; d.innerHTML = `<input type="checkbox" value="${v}"> ${v}`;
                d.addEventListener('click', e => { if(e.target.tagName !== 'INPUT') d.querySelector('input').checked = !d.querySelector('input').checked; applyFilters(); });
                opts.appendChild(d);
            });
            trigger.addEventListener('click', () => { document.querySelectorAll('.custom-options').forEach(o => o !== opts && o.classList.remove('open')); opts.classList.toggle('open'); });
        }
        function initGroupByDropdown() {
            const wrapper = document.getElementById('group-by-select'); const opts = wrapper.querySelector('.custom-options'); const trigger = wrapper.querySelector('.custom-select-trigger span'); const triggerDiv = wrapper.querySelector('.custom-select-trigger');
            const dims = [ {key: 'DESTINO DESCARGA', label: 'Destino'}, {key: 'FECHA RECEPCION', label: 'Fecha'}, {key: 'ESTABLECIMIENTO', label: 'Establecimiento'}, {key: 'LOTE', label: 'Lote'}, {key: 'PRODUCTO', label: 'Producto'}, {key: 'PRODUCTOR', label: 'Productor'}, {key: 'CONTRATISTA', label: 'Contratista'}, {key: 'TOLVA', label: 'Tolva'} ];
            dims.forEach(dim => {
                const d = document.createElement('div'); d.className = 'option-item'; d.innerHTML = `<input type="checkbox" value="${dim.key}"> ${dim.label}`;
                d.addEventListener('click', e => { if(e.target.tagName !== 'INPUT') d.querySelector('input').checked = !d.querySelector('input').checked; applyFilters(); updateGroupLabel(wrapper, trigger, triggerDiv); state.isQuickGroupActive = false; document.getElementById('btn-flash-toggle').classList.remove('active'); document.getElementById('btn-flash-toggle').innerHTML = '<i class="ph ph-stack-plus"></i> Agrupar Destinos'; });
                opts.appendChild(d);
            });
            triggerDiv.addEventListener('click', () => { document.querySelectorAll('.custom-options').forEach(o => o !== opts && o.classList.remove('open')); opts.classList.toggle('open'); });
        }
        function updateGroupLabel(wrapper, trigger, triggerDiv) {
            const checked = Array.from(wrapper.querySelectorAll('input:checked'));
            if (checked.length === 0) { trigger.textContent = "(Sin Agrupar)"; triggerDiv.style.backgroundColor = ""; }
            else { trigger.textContent = `${checked.length} Dimensión(es)`; triggerDiv.style.backgroundColor = "var(--bg-body)"; triggerDiv.style.borderColor = "var(--success)"; triggerDiv.style.color = "var(--success)"; }
        }
        function toggleQuickGroup() {
            const wrapper = document.getElementById('group-by-select'); const checkboxes = wrapper.querySelectorAll('input[type="checkbox"]'); const btn = document.getElementById('btn-flash-toggle');
            if (state.isQuickGroupActive) {
                checkboxes.forEach(cb => cb.checked = false); state.isQuickGroupActive = false; btn.classList.remove('active'); btn.innerHTML = '<i class="ph ph-stack-plus"></i> Agrupar Destinos';
            } else {
                checkboxes.forEach(cb => cb.checked = true); state.isQuickGroupActive = true; btn.classList.add('active'); btn.innerHTML = '<i class="ph ph-list-dashes"></i> Desagrupar';
            }
            applyFilters(); const trigger = wrapper.querySelector('.custom-select-trigger span'); const triggerDiv = wrapper.querySelector('.custom-select-trigger'); updateGroupLabel(wrapper, trigger, triggerDiv);
        }
        function toggleRowSelection(id) { if(state.selectedRows.has(id)) state.selectedRows.delete(id); else state.selectedRows.add(id); updateMassActionUI(); }
        function toggleAllSelection() { const master = document.getElementById('master-checkbox').checked; const displayedIds = state.filtered.filter(r => !r.grouped).map(r => r.id); if (master) displayedIds.forEach(id => state.selectedRows.add(id)); else state.selectedRows.clear(); renderTable(processData()); updateMassActionUI(); }
        function updateMassActionUI() { const bar = document.getElementById('mass-action-bar'); const count = state.selectedRows.size; document.getElementById('selected-count').textContent = `${count} seleccionados`; if (count > 0) bar.classList.add('visible'); else bar.classList.remove('visible'); }
        function openMassEditModal() {
            document.getElementById('mass-est').innerHTML='<option value="">(No cambiar)</option>'; document.getElementById('mass-lote').innerHTML='<option value="">(No cambiar)</option>'; document.getElementById('mass-prod').innerHTML='<option value="">(No cambiar)</option>'; document.getElementById('mass-productor').innerHTML='<option value="">(No cambiar)</option>'; document.getElementById('mass-destino').value = ''; document.getElementById('mass-cp').value = ''; document.getElementById('mass-obs').value = '';
            const fill = (eid, k) => { const e = document.getElementById(eid); [...new Set(state.data.map(r=>r[k]))].sort().forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; e.appendChild(o); }); };
            fill('mass-est', 'ESTABLECIMIENTO'); fill('mass-lote', 'LOTE'); fill('mass-prod', 'PRODUCTO'); fill('mass-productor', 'PRODUCTOR');
            updateMassPreview(); document.getElementById('mass-edit-modal').classList.add('active');
        }
        function updateMassPreview() {
            const tbody = document.getElementById('mass-preview-body'); tbody.innerHTML = '';
            const newEst = document.getElementById('mass-est').value; const newLote = document.getElementById('mass-lote').value; const newProd = document.getElementById('mass-prod').value; const newDest = document.getElementById('mass-destino').value;
            state.data.forEach(row => {
                if (state.selectedRows.has(row.id)) {
                    const estDisplay = newEst ? `<span class="preview-change">${newEst}</span>` : row.ESTABLECIMIENTO;
                    const loteDisplay = newLote ? `<span class="preview-change">${newLote}</span>` : row.LOTE;
                    const prodDisplay = newProd ? `<span class="preview-change">${newProd}</span>` : row.PRODUCTO;
                    const destDisplay = newDest ? `<span class="preview-change">${newDest}</span>` : row['DESTINO DESCARGA'];
                    const kgDisplay = row.PESO_NUM.toLocaleString('es-AR');
                    const tr = document.createElement('tr'); tr.innerHTML = `<td>${estDisplay}</td><td>${loteDisplay}</td><td>${prodDisplay}</td><td>${destDisplay}</td><td style="text-align:right;">${kgDisplay}</td>`; tbody.appendChild(tr);
                }
            });
        }
        function saveMassEdit() {
            const newEst = document.getElementById('mass-est').value; const newLote = document.getElementById('mass-lote').value; const newProd = document.getElementById('mass-prod').value; const newProductor = document.getElementById('mass-productor').value; const newDest = document.getElementById('mass-destino').value; const newCP = document.getElementById('mass-cp').value; const newObs = document.getElementById('mass-obs').value;
            state.data.forEach(row => {
                if (state.selectedRows.has(row.id)) {
                    if(newEst) row['ESTABLECIMIENTO'] = newEst; if(newLote) row['LOTE'] = newLote; if(newProd) row['PRODUCTO'] = newProd; if(newProductor) row['PRODUCTOR'] = newProductor; if(newDest) row['DESTINO DESCARGA'] = newDest; if(newCP) row['CARTA DE PORTE'] = newCP; if(newObs) row['OBSERVACION'] = newObs;
                }
            }); state.selectedRows.clear(); document.getElementById('mass-edit-modal').classList.remove('active'); applyFilters(); alert("Registros actualizados correctamente.");
        }
        function openEditModal(id) { 
            const row = state.data.find(r => r.id === id); if(!row) return;
            const fill = (eid, k, s) => { const e = document.getElementById(eid); e.innerHTML=''; [...new Set(state.data.map(r=>r[k]))].sort().forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; if(v===s) o.selected=true; e.appendChild(o); }); };
            document.getElementById('edit-index').value = id; document.getElementById('edit-fecha').value = row['FECHA RECEPCION']; document.getElementById('edit-kg').value = row['PESO HUMEDO Kg']; document.getElementById('edit-tolva').value = row['TOLVA'];
            fill('edit-est','ESTABLECIMIENTO',row['ESTABLECIMIENTO']); fill('edit-lote','LOTE',row['LOTE']); fill('edit-prod','PRODUCTO',row['PRODUCTO']);
            document.getElementById('edit-modal').classList.add('active');
        }
        function closeEditModal() { document.getElementById('edit-modal').classList.remove('active'); }
        function saveEdit() {
            const id = parseInt(document.getElementById('edit-index').value); const row = state.data.find(r => r.id === id);
            if(row) { row['ESTABLECIMIENTO'] = document.getElementById('edit-est').value; row['LOTE'] = document.getElementById('edit-lote').value; row['PRODUCTO'] = document.getElementById('edit-prod').value; row['TOLVA'] = document.getElementById('edit-tolva').value; applyFilters(); closeEditModal(); }
        }
        function unlockField(fid) { if(prompt("Clave:")==='123') document.getElementById(fid).disabled=false; }
        function openProfileModal() { document.getElementById('prof-name').value=user.name; document.getElementById('prof-lastname').value=user.lastname; document.getElementById('prof-email').value=user.email; document.getElementById('prof-phone').value=user.phone; document.getElementById('profile-modal').classList.add('active'); }
        function saveProfile() { user.name=document.getElementById('prof-name').value; user.lastname=document.getElementById('prof-lastname').value; document.getElementById('header-username').textContent=`${user.name} (${user.lastname})`; document.getElementById('profile-modal').classList.remove('active'); }
        window.initMap = function() { map = new google.maps.Map(document.getElementById("google-map-container"), { zoom: 12, center: { lat: -32.0565, lng: -62.6908 }, mapTypeId: "satellite", streetViewControl: false }); };
        function openMapGlobal() { document.getElementById('map-modal').classList.add('active'); setTimeout(() => { if(map) { google.maps.event.trigger(map, "resize"); updateMapMarkers(state.filtered); } }, 300); }
        function openMapLocal(lat, lng) { document.getElementById('map-modal').classList.add('active'); setTimeout(() => { if(map) { google.maps.event.trigger(map, "resize"); clearMarkers(); const m = new google.maps.Marker({ position: { lat: lat, lng: lng }, map: map, animation: google.maps.Animation.DROP }); mapMarkers.push(m); map.setCenter({ lat: lat, lng: lng }); map.setZoom(16); } }, 300); }
        function openMapGroup(index) { const group = state.groupedData[index]; if(!group || !group.items) return; document.getElementById('map-modal').classList.add('active'); setTimeout(() => { if(map) { google.maps.event.trigger(map, "resize"); updateMapMarkers(group.items); } }, 300); }
        function updateMapMarkers(items) {
            clearMarkers(); const bounds = new google.maps.LatLngBounds(); let c=0; 
            items.forEach(r => { if (!isNaN(r.LAT_NUM) && !isNaN(r.LNG_NUM) && r.LAT_NUM !== 0) { const pos = { lat: r.LAT_NUM, lng: r.LNG_NUM }; const m = new google.maps.Marker({ position: pos, map: map, title: r.ESTABLECIMIENTO, icon: r.IS_AUTO ? 'http://maps.google.com/mapfiles/ms/icons/green-dot.png' : 'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png' }); const info = new google.maps.InfoWindow({ content: `<b>${r.ESTABLECIMIENTO}</b><br>Destino: ${r['DESTINO DESCARGA']}<br>Hora: ${r['HORA RECEPCION']}<br>Tolva: ${r.TOLVA}<br>Peso: ${r.PESO_NUM}kg` }); m.addListener("click", () => info.open(map, m)); mapMarkers.push(m); bounds.extend(pos); c++; } }); 
            if(c>0) map.fitBounds(bounds); 
        }
        function clearMarkers() { mapMarkers.forEach(m => m.setMap(null)); mapMarkers = []; }
        function closeMap() { document.getElementById('map-modal').classList.remove('active'); }
        document.addEventListener('click', e => { if(!e.target.closest('.custom-select-wrapper')) document.querySelectorAll('.custom-options').forEach(o => o.classList.remove('open')); });
        
        init();
    </script>
</body>
</html>
