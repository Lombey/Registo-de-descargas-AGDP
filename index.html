<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Descargas - ISO 9001</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --bg-body: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text-main: #0f172a;
            --text-light: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6; 
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* --- Header --- */
        header {
            background-color: var(--surface);
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
            z-index: 20;
        }

        .brand { display: flex; align-items: center; gap: 0.75rem; }
        .brand h1 { font-size: 1.125rem; font-weight: 600; color: var(--text-main); }
        
        .user-profile {
            display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;
            color: var(--text-light); background: #f1f5f9; padding: 0.25rem 0.75rem;
            border-radius: 999px; cursor: pointer; transition: background 0.2s;
            border: 1px solid transparent;
        }
        .user-profile:hover { background: #e2e8f0; border-color: var(--border); }

        /* --- Dashboard --- */
        .dashboard {
            flex: 1; display: flex; flex-direction: column; padding: 1rem; gap: 1rem; overflow: hidden;
        }

        /* KPI */
        .kpi-container {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;
        }
        .kpi-card {
            background: var(--surface); padding: 0.75rem 1rem; border-radius: 0.5rem;
            border: 1px solid var(--border); box-shadow: var(--shadow-sm);
            display: flex; flex-direction: column; justify-content: center;
        }
        .kpi-label { font-size: 0.7rem; text-transform: uppercase; font-weight: 600; color: var(--text-light); margin-bottom: 0.25rem; }
        .kpi-value { font-size: 1.25rem; font-weight: 700; color: var(--text-main); letter-spacing: -0.02em; }

        /* Controls */
        .controls-container {
            background-color: var(--surface); padding: 0.75rem; border-radius: 0.5rem;
            border: 1px solid var(--border); box-shadow: var(--shadow-sm);
            display: flex; flex-direction: column; gap: 0.75rem; z-index: 10;
        }
        .filters-row { display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; }

        /* Custom Dropdown */
        .custom-select-wrapper { position: relative; min-width: 130px; flex-grow: 1; }
        .custom-select-trigger {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.4rem 0.75rem; font-size: 0.8rem; background: #fff;
            border: 1px solid var(--border); border-radius: 0.375rem; cursor: pointer;
            transition: all 0.2s; color: var(--text-light);
        }
        .custom-select-trigger:hover { border-color: var(--primary); color: var(--text-main); }
        .group-by-wrapper .custom-select-trigger { background-color: #f0fdf4; border-color: #86efac; color: #166534; font-weight: 600; }
        
        .custom-options {
            position: absolute; top: 100%; left: 0; right: 0; background: #fff;
            border: 1px solid var(--border); border-radius: 0.375rem; margin-top: 4px;
            box-shadow: var(--shadow-md); display: none; z-index: 30; max-height: 300px;
            overflow-y: auto; padding: 0.5rem;
        }
        .custom-options.open { display: block; }
        .option-item {
            display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem;
            cursor: pointer; border-radius: 0.25rem; font-size: 0.8rem;
        }
        .option-item:hover { background-color: var(--bg-body); }

        /* Inputs & Buttons */
        .search-input-wrapper { position: relative; min-width: 160px; flex-grow: 1; }
        .search-input {
            width: 100%; padding: 0.4rem 0.75rem 0.4rem 2rem; font-size: 0.8rem;
            border: 1px solid var(--border); border-radius: 0.375rem; font-family: 'Inter', sans-serif;
            transition: all 0.2s;
        }
        .search-input:focus { outline: none; border-color: var(--primary); }
        .search-icon { position: absolute; left: 0.6rem; top: 50%; transform: translateY(-50%); color: var(--text-light); }

        .btn {
            display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.8rem;
            border-radius: 0.375rem; font-size: 0.8rem; font-weight: 600; cursor: pointer;
            border: none; transition: background 0.2s;
        }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-outline { background-color: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-outline:hover { background-color: var(--bg-body); border-color: #cbd5e1; }
        .btn-icon { padding: 0.4rem; border-radius: 0.25rem; background: transparent; border: none; cursor: pointer; color: var(--text-light); }
        .btn-icon:hover { background-color: #f1f5f9; color: var(--primary); }

        .btn-flash { color: var(--text-main); border: 1px solid var(--border); background: #fff; width: 180px; justify-content: center; }
        .btn-flash.active { color: white; border: 1px solid var(--primary); background: var(--primary); }

        .toggle-filter { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; color: var(--text-light); cursor: pointer; user-select: none; }

        /* --- Table --- */
        .table-container {
            flex: 1; background: var(--surface); border-radius: 0.5rem;
            border: 1px solid var(--border); box-shadow: var(--shadow-sm);
            overflow: auto; position: relative;
        }
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.8rem; }
        thead { position: sticky; top: 0; z-index: 5; background-color: #f1f5f9; }
        th {
            text-align: left; padding: 0.75rem 1rem; font-weight: 600; color: var(--text-light);
            border-bottom: 1px solid var(--border); white-space: nowrap; background-color: #f1f5f9;
        }
        td {
            padding: 0.6rem 1rem; border-bottom: 1px solid var(--border);
            color: var(--text-main); white-space: nowrap; vertical-align: middle;
        }
        th.text-right, td.text-right { text-align: right; }
        tbody tr:hover { background-color: #f8fafc; }
        .row-grouped { background-color: #eff6ff; font-weight: 600; color: var(--primary-dark); }
        .checkbox-cell { width: 30px; text-align: center; }
        
        /* Fixed Width Action Columns (Right Aligned) */
        .col-tight { width: 1%; white-space: nowrap; padding-left: 0.5rem; padding-right: 0.5rem; }

        /* Map Trigger & Validation */
        .map-trigger {
            color: var(--primary); cursor: pointer; padding: 4px; border-radius: 4px;
            transition: background 0.2s; display: inline-flex;
        }
        .map-trigger:hover { background-color: #eff6ff; }

        .val-badge {
            cursor: pointer; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; display: inline-block;
        }
        .val-ok { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .val-no { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

        /* Compact Column Config Button */
        .col-config-wrapper { position: relative; }
        .col-config-btn { 
            padding: 0.4rem; min-width: 32px; width: 32px; height: 32px; 
            display: flex; align-items: center; justify-content: center;
        }

        /* --- Mass Action Bar --- */
        .mass-action-bar {
            background-color: white; color: var(--text-main); padding: 0.5rem 1rem;
            border-radius: 0.5rem; display: flex; align-items: center; gap: 1rem;
            font-size: 0.85rem; margin-left: auto;
            border: 1px solid var(--border); box-shadow: var(--shadow-lg);
            opacity: 0; pointer-events: none; transition: opacity 0.2s, transform 0.2s;
            transform: translateY(10px);
        }
        .mass-action-bar.visible { opacity: 1; pointer-events: all; transform: translateY(0); }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.4); display: flex; justify-content: center;
            align-items: center; z-index: 1000; opacity: 0; pointer-events: none;
            transition: opacity 0.2s; backdrop-filter: blur(2px);
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        
        .modal-card {
            background: white; width: 90%; max-width: 1000px; height: 85vh;
            border-radius: 0.75rem; display: flex; flex-direction: column;
            overflow: hidden; box-shadow: var(--shadow-lg);
        }

        #google-map-container { width: 100%; height: 100%; background: #e2e8f0; }

        .modal-sm { max-width: 500px; height: auto; max-height: 90vh; overflow-y: auto; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; padding: 1.5rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .form-group.full-width { grid-column: span 2; }
        .form-label { font-size: 0.8rem; font-weight: 600; color: var(--text-light); }
        .form-input, .form-select {
            padding: 0.5rem; border: 1px solid var(--border); border-radius: 0.375rem;
            font-family: 'Inter', sans-serif; font-size: 0.9rem;
        }
        .form-input:disabled { background-color: #f1f5f9; color: #94a3b8; cursor: not-allowed; }
        .modal-footer {
            padding: 1rem 1.5rem; border-top: 1px solid var(--border); background-color: #f8fafc;
            display: flex; justify-content: flex-end; gap: 0.75rem;
        }
        .section-title {
            grid-column: span 2; font-size: 0.9rem; font-weight: 600; color: var(--primary);
            border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; margin-top: 1rem;
        }

    </style>
</head>
<body>

    <header>
        <div class="brand">
            <div style="background: var(--primary); padding: 6px; border-radius: 6px; display: flex;">
                <i class="ph ph-truck" style="font-size: 1.25rem; color: white;"></i>
            </div>
            <h1>Descargas <span style="font-weight: 400; color: var(--text-light); font-size: 0.9em;">| ISO 9001</span></h1>
        </div>
        
        <div class="user-profile" onclick="openProfileModal()" title="Editar Perfil">
            <i class="ph ph-user-circle" style="font-size: 1.25rem;"></i>
            <span id="header-username">Martin (Gerente)</span>
        </div>
    </header>

    <div class="dashboard">
        
        <!-- KPI -->
        <section class="kpi-container">
            <div class="kpi-card"><div class="kpi-label">Total Kg Húmedo</div><div class="kpi-value" id="kpi-total-kg">0</div></div>
            <div class="kpi-card"><div class="kpi-label">Total Kg Seco</div><div class="kpi-value" id="kpi-total-sec">0</div></div>
            <div class="kpi-card"><div class="kpi-label">Registros / Grupos</div><div class="kpi-value" id="kpi-count">0</div></div>
            <div class="kpi-card"><div class="kpi-label">Promedio Kg</div><div class="kpi-value" id="kpi-avg">0</div></div>
        </section>

        <!-- Filters -->
        <section class="controls-container">
            <div class="filters-row">
                <div class="custom-select-wrapper" id="filter-est"><div class="custom-select-trigger"><span>Establecimiento</span> <i class="ph ph-caret-down"></i></div><div class="custom-options"></div></div>
                <div class="custom-select-wrapper" id="filter-lote"><div class="custom-select-trigger"><span>Lote</span> <i class="ph ph-caret-down"></i></div><div class="custom-options"></div></div>
                <div class="custom-select-wrapper" id="filter-prod"><div class="custom-select-trigger"><span>Producto</span> <i class="ph ph-caret-down"></i></div><div class="custom-options"></div></div>
                <div class="custom-select-wrapper" id="filter-productor"><div class="custom-select-trigger"><span>Productor</span> <i class="ph ph-caret-down"></i></div><div class="custom-options"></div></div>
                <div class="custom-select-wrapper" id="filter-tolva"><div class="custom-select-trigger"><span>Tolva</span> <i class="ph ph-caret-down"></i></div><div class="custom-options"></div></div>
                
                <div class="search-input-wrapper">
                    <i class="ph ph-magnifying-glass search-icon"></i>
                    <input type="text" id="filter-destino-text" class="search-input" placeholder="Buscar Destino..." oninput="applyFilters()">
                </div>
                
                <label class="toggle-filter" title="Excluir descargas menores a 100kg">
                    <input type="checkbox" id="filter-hide-low" onchange="applyFilters()"> 
                    Ocultar < 100kg
                </label>
            </div>

            <div class="filters-row" style="justify-content: space-between; border-top: 1px solid var(--border); padding-top: 0.75rem; margin-top: 0.5rem;">
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    
                    <div style="display:flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 0.8rem; font-weight: 600; color: var(--text-light); text-transform: uppercase;">Agrupar:</span>
                        <div class="custom-select-wrapper group-by-wrapper" id="group-by-select">
                            <div class="custom-select-trigger"><span>(Sin Agrupar)</span> <i class="ph ph-stack"></i></div>
                            <div class="custom-options"></div>
                        </div>
                    </div>

                    <button class="btn btn-flash" id="btn-flash-toggle" onclick="toggleQuickGroup()">
                        <i class="ph ph-stack-plus"></i> Agrupar Destinos
                    </button>

                    <!-- Barra de Acción Masiva -->
                    <div id="mass-action-bar" class="mass-action-bar">
                        <span id="selected-count" style="font-weight: 600; color: var(--primary);">0 seleccionados</span>
                        <button class="btn btn-primary" style="padding: 0.3rem 0.8rem; font-size: 0.8rem;" onclick="openMassEditModal()">
                            <i class="ph ph-pencil-simple"></i> Editar Selección
                        </button>
                    </div>

                </div>

                <div style="display:flex; gap: 0.5rem; align-items: center;">
                    <button class="btn btn-primary" onclick="openMapGlobal()"><i class="ph ph-map-trifold"></i> Ver Mapa Global</button>
                    
                    <!-- Botón Configuración Columnas Compacto -->
                    <div class="custom-select-wrapper col-config-wrapper" id="col-config">
                        <div class="custom-select-trigger col-config-btn" title="Configurar Columnas">
                            <i class="ph ph-gear"></i>
                        </div>
                        <div class="custom-options" style="right: 0; left: auto; width: 200px;">
                            <!-- Column options injected here -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Table -->
        <section class="table-container">
            <table id="main-table">
                <thead>
                    <tr id="table-header-row">
                        <!-- JS Injects Headers -->
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- JS Injects Rows -->
                </tbody>
            </table>
        </section>
    </div>

    <!-- Modal Mapa -->
    <div class="modal-overlay" id="map-modal">
        <div class="modal-card">
            <div class="modal-header" style="padding: 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <h3>Geolocalización</h3>
                <button class="btn-icon" onclick="closeMap()"><i class="ph ph-x" style="font-size: 1.5rem;"></i></button>
            </div>
            <div style="flex: 1; position: relative;">
                <div id="google-map-container"></div>
            </div>
        </div>
    </div>

    <!-- Modal Edición Simple -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal-card modal-sm">
            <div class="modal-header" style="padding: 1rem; border-bottom: 1px solid var(--border);">
                <h3>Modificar Descarga</h3>
            </div>
            <div class="form-grid">
                <input type="hidden" id="edit-index">
                <div class="form-group"><label class="form-label">Fecha</label><div class="lock-wrapper"><input type="text" id="edit-fecha" class="form-input" disabled style="width:100%"><button class="unlock-btn" onclick="unlockField('edit-fecha')"><i class="ph ph-lock-key"></i></button></div></div>
                <div class="form-group"><label class="form-label">Kg Húmedo</label><div class="lock-wrapper"><input type="text" id="edit-kg" class="form-input" disabled style="width:100%"><button class="unlock-btn" onclick="unlockField('edit-kg')"><i class="ph ph-lock-key"></i></button></div></div>
                <div class="form-group full-width"><label class="form-label">Establecimiento</label><select id="edit-est" class="form-select"></select></div>
                <div class="form-group"><label class="form-label">Lote</label><select id="edit-lote" class="form-select"></select></div>
                <div class="form-group"><label class="form-label">Producto</label><select id="edit-prod" class="form-select"></select></div>
                <div class="form-group full-width"><label class="form-label">Tolva</label><input type="text" id="edit-tolva" class="form-input"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeEditModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveEdit()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Edición Masiva -->
    <div class="modal-overlay" id="mass-edit-modal">
        <div class="modal-card modal-sm">
            <div class="modal-header" style="padding: 1rem; border-bottom: 1px solid var(--border);">
                <h3>Edición Múltiple</h3>
                <p style="font-size:0.8rem; color:var(--text-light)">Editando <span id="mass-edit-count">0</span> registros. Deje en blanco lo que no quiera cambiar.</p>
            </div>
            <div class="form-grid">
                <div class="form-group"><label class="form-label">Establecimiento</label><select id="mass-est" class="form-select"><option value="">(No cambiar)</option></select></div>
                <div class="form-group"><label class="form-label">Lote</label><select id="mass-lote" class="form-select"><option value="">(No cambiar)</option></select></div>
                <div class="form-group"><label class="form-label">Producto</label><select id="mass-prod" class="form-select"><option value="">(No cambiar)</option></select></div>
                <div class="form-group"><label class="form-label">Productor</label><select id="mass-productor" class="form-select"><option value="">(No cambiar)</option></select></div>
                <div class="form-group"><label class="form-label">Destino</label><input type="text" id="mass-destino" class="form-input" placeholder="(No cambiar)"></div>
                <div class="form-group"><label class="form-label">Carta Porte</label><input type="text" id="mass-cp" class="form-input" placeholder="(No cambiar)"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="document.getElementById('mass-edit-modal').classList.remove('active')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveMassEdit()">Aplicar a Todos</button>
            </div>
        </div>
    </div>

    <!-- Modal Perfil -->
    <div class="modal-overlay" id="profile-modal">
        <div class="modal-card modal-sm">
            <div class="modal-header" style="padding: 1rem; border-bottom: 1px solid var(--border);">
                <h3>Mi Perfil</h3>
            </div>
            <div class="form-grid">
                <div class="form-group"><label class="form-label">Nombre</label><input type="text" id="prof-name" class="form-input"></div>
                <div class="form-group"><label class="form-label">Apellido</label><input type="text" id="prof-lastname" class="form-input"></div>
                <div class="form-group"><label class="form-label">Email</label><input type="email" id="prof-email" class="form-input"></div>
                <div class="form-group"><label class="form-label">Teléfono</label><input type="text" id="prof-phone" class="form-input"></div>
                <div class="section-title">Cambiar Contraseña</div>
                <div class="form-group full-width"><label class="form-label">Clave Anterior</label><input type="password" id="prof-old-pass" class="form-input"></div>
                <div class="form-group"><label class="form-label">Nueva Clave</label><input type="password" id="prof-new-pass" class="form-input"></div>
                <div class="form-group"><label class="form-label">Confirmar</label><input type="password" id="prof-confirm-pass" class="form-input"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="document.getElementById('profile-modal').classList.remove('active')">Cerrar</button>
                <button class="btn btn-primary" onclick="saveProfile()">Guardar Perfil</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT DE GOOGLE MAPS -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBixHiS7Z6kVhh0tN7g9NdZaKrFxSji140&callback=initMap" async defer></script>

    <script>
        // --- 1. DATOS ---
        const rawCSV = `TIPO,FECHA RECEPCION,HORA RECEPCION,FECHA PESADA,HORA PESADA,PRODUCTOR,CONTRATISTA,ESTABLECIMIENTO,LOTE,PRODUCTO,HUMEDAD,DESTINO DESCARGA,CARTA DE PORTE,TOLVA,PESO HUMEDO Kg,PESO SECO Kg,LATITUD,LONGITUD,PRE LIMPIEZA,AUTORIZACION CARGA,VALIZACION
AUTMATICA,26/11/2025,10:17:11,26/11/2025,10:17:13,LA SARAH,CARO,LA SARAH,LOTE 1,TRIGO,0,SIN DATOS,N/A,SCARO1,0,0,-32.056583,-62.690865,NO,S/D,FALSE
MODIFICADA,26/11/2025,10:27:35,26/11/2025,10:27:36,LA SARAH,CARO,LA SARAH,LOTE 26,TRIGO,0,XLZ632,N/A,SCARO1,24400,24400,-32.05652,-62.690865,NO,S/D,TRUE
MODIFICADA TABLET,26/11/2025,10:54:20,26/11/2025,10:54:22,LA SARAH,CARO,LA SARAH,LOTE 26,TRIGO,0,XLZ632,N/A,SCARO1,25000,25000,-32.056491,-62.690865,NO,S/D,TRUE
MANUAL,27/11/2025,01:27:44,27/11/2025,01:27:46,LA SARAH,PEREZ,LA SARAH,LOTE 38,TRIGO,0,GCF389,N/A,TOLVA-X,15380,15380,-32.060341,-62.691928,NO,S/D,FALSE
DEFECTUOSA,27/11/2025,01:29:59,27/11/2025,01:30:01,LA SARAH,CARO,LA SARAH,LOTE 38,TRIGO,0,GCF389,N/A,SCARO1,0,0,-32.060624,-62.691463,NO,S/D,FALSE
AUTMATICA,27/11/2025,01:49:07,27/11/2025,01:49:03,LA SARAH,CARO,LA SARAH,LOTE 38,TRIGO,0,GCF389,N/A,SCARO1,20,20,-32.060354,-62.691475,NO,S/D,FALSE
MANUAL,27/11/2025,02:12:44,27/11/2025,02:12:46,EL CEIBO,LOPEZ,EL CEIBO,LOTE 39,MAIZ,0,SIN DATOS,N/A,TOLVA-Y,35000,35000,-32.060341,-62.691928,NO,S/D,FALSE
AUTMATICA,27/11/2025,02:14:20,27/11/2025,02:14:22,LA SARAH,CARO,LA SARAH,LOTE 39,MAIZ,0,XLZ632,N/A,SCARO1,24800,24800,-32.060354,-62.691475,NO,S/D,TRUE
AUTMATICA,27/11/2025,02:20:10,27/11/2025,02:20:12,LA SARAH,CARO,LA SARAH,LOTE 39,MAIZ,0,GCF389,N/A,SCARO1,500,500,-32.060341,-62.691928,NO,S/D,FALSE`;

        // Column Config
        let colConfig = {
            'STATUS': { label: 'Estado', visible: true, width: '50px' },
            'FECHA RECEPCION': { label: 'Fecha Recep', visible: true, dimensionKey: 'FECHA RECEPCION' },
            'HORA RECEPCION': { label: 'Hora Recep', visible: false, dimensionKey: 'HORA RECEPCION' }, 
            'ESTABLECIMIENTO': { label: 'Establecimiento', visible: true, dimensionKey: 'ESTABLECIMIENTO' },
            'LOTE': { label: 'Lote', visible: true, dimensionKey: 'LOTE' },
            'PRODUCTO': { label: 'Producto', visible: true, dimensionKey: 'PRODUCTO' },
            'TOLVA': { label: 'Tolva', visible: true, dimensionKey: 'TOLVA' },
            'DESTINO DESCARGA': { label: 'Destino', visible: true, dimensionKey: 'DESTINO DESCARGA' },
            'CARTA DE PORTE': { label: 'Carta Porte', visible: true, dimensionKey: 'CARTA DE PORTE' },
            'VALIDACION': { label: 'Validación', visible: true, dimensionKey: 'VALIDACION' }, // Not a dimension but shown normally
            'PESO_NUM': { label: 'Kg Húmedo', visible: true, align: 'right' },
            'ACTIONS': { label: '', visible: true, width: '1%' },
            'UBICACION': { label: 'Ubic.', visible: true, align: 'center', width: '1%' } 
        };

        let user = { name: "Martin", lastname: "Gerente", email: "martin@iso9001.com", phone: "123-4567", password: "123" };
        let state = {
            data: [], filtered: [], groupByKeys: [], isQuickGroupActive: false, selectedRows: new Set(),
            groupedData: [] // Store processed groups for Map access
        };
        let map; let mapMarkers = [];

        // --- 2. LOGICA INICIAL ---
        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1).map((line, idx) => {
                const values = line.split(',');
                const obj = { id: idx }; 
                headers.forEach((h, i) => obj[h] = values[i] ? values[i].trim() : '');
                
                obj['PESO_NUM'] = parseFloat(obj['PESO HUMEDO Kg']) || 0;
                obj['PESO_SECO_NUM'] = parseFloat(obj['PESO SECO Kg']) || 0;
                obj['LAT_NUM'] = parseFloat(obj['LATITUD']);
                obj['LNG_NUM'] = parseFloat(obj['LONGITUD']);
                obj['GEO_POINT'] = (!isNaN(obj['LAT_NUM']) && !isNaN(obj['LNG_NUM'])) ? `${obj['LAT_NUM'].toFixed(4)}, ${obj['LNG_NUM'].toFixed(4)}` : '';
                
                // Logic for Status
                const tipo = (obj['TIPO'] || '').toUpperCase();
                obj['IS_MOD_WEB'] = tipo.includes('MODIFICADA') && !tipo.includes('TABLET');
                obj['IS_MOD_TABLET'] = tipo.includes('MODIFICADA TABLET');
                obj['IS_DEFECT'] = tipo.includes('DEFECTUOSA');
                obj['IS_AUTO'] = tipo.includes('AUT') || obj['IS_MOD_WEB'] || obj['IS_MOD_TABLET']; 
                obj['IS_OVERWEIGHT'] = obj['PESO_NUM'] > 30000;

                obj['IS_VALID'] = (obj['VALIZACION'] && obj['VALIZACION'].toUpperCase() === 'TRUE');
                obj['AUTH_CODE'] = obj['AUTORIZACION CARGA'] || 'N/A';
                return obj;
            });
        }

        function init() {
            state.data = parseCSV(rawCSV);
            state.filtered = [...state.data];
            
            initDropdown('filter-est', 'ESTABLECIMIENTO');
            initDropdown('filter-lote', 'LOTE');
            initDropdown('filter-prod', 'PRODUCTO');
            initDropdown('filter-productor', 'PRODUCTOR');
            initDropdown('filter-tolva', 'TOLVA');

            initGroupByDropdown();
            initColumnConfig(); 
            updateUI();
        }

        // --- 3. FILTROS ---
        function applyFilters() {
            const getVals = id => Array.from(document.querySelectorAll(`#${id} input:checked`)).map(c => c.value);
            const fEst = getVals('filter-est');
            const fLote = getVals('filter-lote');
            const fProd = getVals('filter-prod');
            const fProductor = getVals('filter-productor');
            const fTolva = getVals('filter-tolva');
            const destQuery = document.getElementById('filter-destino-text').value.toLowerCase();
            const hideLow = document.getElementById('filter-hide-low').checked;
            
            state.groupByKeys = Array.from(document.querySelectorAll(`#group-by-select input:checked`)).map(c => c.value);

            state.filtered = state.data.filter(r => {
                if (hideLow && r.PESO_NUM < 100) return false;
                const matchEst = fEst.length === 0 || fEst.includes(r['ESTABLECIMIENTO']);
                const matchLote = fLote.length === 0 || fLote.includes(r['LOTE']);
                const matchProd = fProd.length === 0 || fProd.includes(r['PRODUCTO']);
                const matchProductor = fProductor.length === 0 || fProductor.includes(r['PRODUCTOR']);
                const matchTolva = fTolva.length === 0 || fTolva.includes(r['TOLVA']);
                const matchDest = !destQuery || r['DESTINO DESCARGA'].toLowerCase().includes(destQuery);
                return matchEst && matchLote && matchProd && matchProductor && matchTolva && matchDest;
            });
            updateUI();
        }

        // --- 4. COLUMN CONFIG ---
        function initColumnConfig() {
            const wrapper = document.getElementById('col-config');
            if(!wrapper) return;
            const opts = wrapper.querySelector('.custom-options');
            const trigger = wrapper.querySelector('.custom-select-trigger');

            Object.keys(colConfig).forEach(key => {
                const conf = colConfig[key];
                if(conf.label === '') return; 
                const d = document.createElement('div');
                d.className = 'option-item';
                d.innerHTML = `<input type="checkbox" ${conf.visible ? 'checked' : ''}> ${conf.label}`;
                d.addEventListener('click', e => {
                    if(e.target.tagName !== 'INPUT') d.querySelector('input').checked = !d.querySelector('input').checked;
                    colConfig[key].visible = d.querySelector('input').checked;
                    updateUI();
                });
                opts.appendChild(d);
            });

            trigger.addEventListener('click', () => {
                document.querySelectorAll('.custom-options').forEach(o => o !== opts && o.classList.remove('open'));
                opts.classList.toggle('open');
            });
        }

        // --- 5. RENDER UI ---
        function updateUI() {
            state.groupedData = processData();
            renderTableHeader();
            renderTable(state.groupedData);
            renderKPIs(state.groupedData);
            updateMassActionUI();
        }

        function renderTableHeader() {
            const tr = document.getElementById('table-header-row');
            tr.innerHTML = `<th class="checkbox-cell"><input type="checkbox" id="master-checkbox" onchange="toggleAllSelection()"></th>`;
            
            Object.keys(colConfig).forEach(key => {
                const conf = colConfig[key];
                
                // SMART GRID LOGIC: If grouped, hide columns not in group keys
                let showColumn = conf.visible;
                if (state.groupByKeys.length > 0) {
                    // Logic: Show if it's special (Actions, Status, Weights, Map) OR if it is in groupByKeys
                    const isSpecial = ['STATUS', 'PESO_NUM', 'ACTIONS', 'UBICACION'].includes(key);
                    const isInGroup = conf.dimensionKey && state.groupByKeys.includes(conf.dimensionKey);
                    
                    if (!isSpecial && !isInGroup) {
                        showColumn = false;
                    }
                }

                if (showColumn) {
                    const style = conf.width ? `width: ${conf.width};` : '';
                    const align = conf.align ? `text-align: ${conf.align};` : '';
                    // Extra style for tight columns
                    const classes = (key === 'ACTIONS' || key === 'UBICACION') ? 'col-tight' : '';
                    tr.innerHTML += `<th class="${classes}" style="${style} ${align}">${conf.label}</th>`;
                }
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                const colSpan = Object.values(colConfig).length + 1;
                tbody.innerHTML = `<tr><td colspan="${colSpan}" style="text-align:center; padding: 2rem; color: #64748b;">Sin resultados.</td></tr>`;
                return;
            }

            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                if (row.grouped) tr.classList.add('row-grouped');
                
                // 1. Checkbox
                let checkHtml = '';
                if (!row.grouped) {
                    const isSelected = state.selectedRows.has(row.id);
                    checkHtml = `<input type="checkbox" onchange="toggleRowSelection(${row.id})" ${isSelected ? 'checked' : ''}>`;
                }
                let html = `<td class="checkbox-cell">${checkHtml}</td>`;

                // 2. Render Configured Columns
                Object.keys(colConfig).forEach(key => {
                    const conf = colConfig[key];
                    
                    // SMART GRID VISIBILITY CHECK
                    let showColumn = conf.visible;
                    if (state.groupByKeys.length > 0) {
                        const isSpecial = ['STATUS', 'PESO_NUM', 'ACTIONS', 'UBICACION'].includes(key);
                        const isInGroup = conf.dimensionKey && state.groupByKeys.includes(conf.dimensionKey);
                        if (!isSpecial && !isInGroup) showColumn = false;
                    }

                    if (!showColumn) return;
                    
                    let content = '';
                    let align = colConfig[key].align ? `text-align: ${colConfig[key].align};` : '';
                    let classes = '';

                    if (key === 'STATUS') {
                        if (row.grouped) {
                            content = `<span style="background:#dbeafe; padding:2px 6px; border-radius:4px; font-size:0.7rem; color:#1e40af; font-weight:bold;">${row.count} Regs</span>`;
                        } else {
                            if (row.IS_DEFECT) {
                                content = `<i class="ph ph-warning-diamond" style="color:var(--danger); font-size: 1.2rem;" title="Defectuosa: Problema eléctrico o de apagado de caja durante la descarga"></i>`;
                            } else if (row.IS_OVERWEIGHT) {
                                content = `<i class="ph ph-warning" style="color:var(--warning); font-size: 1.2rem;" title="Sobrepeso: Descarga mayor a la capacidad de la tolva"></i>`;
                            } else if (row.IS_MOD_TABLET) {
                                content = `<i class="ph ph-pencil-simple" style="color:var(--info); font-size: 1.2rem;" title="Modificada Tablet: Se modificó desde la tablet de origen"></i>`;
                            } else if (row.IS_MOD_WEB) {
                                content = `<i class="ph ph-pencil-simple" style="color:var(--warning); font-size: 1.2rem;" title="Modificada Web: Se modificó desde la web"></i>`;
                            } else if (row.IS_AUTO) {
                                content = `<i class="ph ph-check-circle" style="color:var(--success); font-size: 1.2rem;" title="Automática"></i>`;
                            } else {
                                content = `<i class="ph ph-warning-circle" style="color:var(--warning); font-size: 1.2rem;" title="Manual"></i>`;
                            }
                        }
                        align = 'text-align: center;';
                    } 
                    else if (key === 'VALIDACION') {
                        if (row.grouped) content = '-';
                        else {
                            const cls = row.IS_VALID ? 'val-ok' : 'val-no';
                            const txt = row.IS_VALID ? 'Validada' : 'No Val.';
                            content = `<span class="val-badge ${cls}" onclick="alert('Código Autorización: ${row.AUTH_CODE}')">${txt}</span>`;
                        }
                    }
                    else if (key === 'ACTIONS') {
                        content = (!row.grouped) ? `<button class="btn-icon" onclick="openEditModal(${row.id})"><i class="ph ph-pencil-simple"></i></button>` : '';
                        align = 'text-align: center;';
                        classes = 'col-tight';
                    }
                    else if (key === 'UBICACION') {
                        // MAP ICON FOR SINGLE AND GROUP
                        if (row.grouped) {
                             content = `<div class="map-trigger" onclick="openMapGroup(${index})" title="Ver Mapa de Grupo (Multi-puntos)"><i class="ph ph-map-pin"></i></div>`;
                        } else if (row.GEO_POINT) {
                            content = `<div class="map-trigger" onclick="openMapLocal(${row.LAT_NUM}, ${row.LNG_NUM})" title="Ver ubicación"><i class="ph ph-map-pin"></i></div>`;
                        }
                        align = 'text-align: center;';
                        classes = 'col-tight';
                    }
                    else if (key === 'PESO_NUM') {
                        content = `<b>${row.PESO_NUM.toLocaleString('es-AR')}</b>`;
                    }
                    else {
                        // Regular Fields
                        let val = row[key];
                        if (row.grouped) {
                            // Only show if part of group key (already filtered by smart grid logic, but double check)
                            if (state.groupByKeys.includes(key)) content = `<strong>${val}</strong>`;
                            else content = '-';
                        } else {
                            content = val;
                        }
                    }
                    
                    html += `<td class="${classes}" style="${align}">${content}</td>`;
                });

                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
        }

        // --- 6. PROCESAMIENTO AGRUPACIÓN ---
        function processData() {
            if (state.groupByKeys.length === 0) return state.filtered;
            const groups = {};
            state.filtered.forEach(row => {
                const groupKeyValues = state.groupByKeys.map(k => row[k]);
                const groupKey = groupKeyValues.join('|');
                if (!groups[groupKey]) {
                    groups[groupKey] = {
                        grouped: true, count: 0, PESO_NUM: 0, PESO_SECO_NUM: 0,
                        items: [], // Store all items in group for map
                        ...Object.fromEntries(state.groupByKeys.map(k => [k, row[k]])),
                        // Defaults for ungrouped columns
                        'FECHA RECEPCION': '-', 'HORA RECEPCION': '-', 'ESTABLECIMIENTO': '-', 
                        'LOTE': '-', 'PRODUCTO': '-', 'TOLVA': '-', 'DESTINO DESCARGA': '-', 
                        'CARTA DE PORTE': '-', 'VALIDACION': '-', 'GEO_POINT': ''
                    };
                    state.groupByKeys.forEach(k => groups[groupKey][k] = row[k]);
                }
                groups[groupKey].PESO_NUM += row.PESO_NUM;
                groups[groupKey].PESO_SECO_NUM += row.PESO_SECO_NUM;
                groups[groupKey].count++;
                groups[groupKey].items.push(row); // Collect rows
            });
            return Object.values(groups);
        }

        function renderKPIs(data) {
            const total = data.reduce((s, r) => s + r.PESO_NUM, 0);
            const totalSec = data.reduce((s, r) => s + r.PESO_SECO_NUM, 0);
            const avg = data.length > 0 ? total / data.length : 0;
            document.getElementById('kpi-total-kg').textContent = total.toLocaleString('es-AR');
            document.getElementById('kpi-total-sec').textContent = totalSec.toLocaleString('es-AR');
            document.getElementById('kpi-count').textContent = data.length;
            document.getElementById('kpi-avg').textContent = avg.toLocaleString('es-AR', {maximumFractionDigits: 0});
        }

        // --- 7. EDICIÓN MASIVA ---
        function toggleRowSelection(id) {
            if(state.selectedRows.has(id)) state.selectedRows.delete(id); else state.selectedRows.add(id);
            updateMassActionUI();
        }
        function toggleAllSelection() {
            const master = document.getElementById('master-checkbox').checked;
            const displayedIds = state.filtered.filter(r => !r.grouped).map(r => r.id);
            if (master) displayedIds.forEach(id => state.selectedRows.add(id)); else state.selectedRows.clear();
            renderTable(processData()); updateMassActionUI();
        }
        function updateMassActionUI() {
            const bar = document.getElementById('mass-action-bar');
            const count = state.selectedRows.size;
            document.getElementById('selected-count').textContent = `${count} seleccionados`;
            if (count > 0) bar.classList.add('visible'); else bar.classList.remove('visible');
        }
        function openMassEditModal() {
            document.getElementById('mass-edit-count').textContent = state.selectedRows.size;
            const fill = (eid, k) => { 
                const e = document.getElementById(eid); e.innerHTML='<option value="">(No cambiar)</option>'; 
                [...new Set(state.data.map(r=>r[k]))].sort().forEach(v=>{
                    const o=document.createElement('option'); o.value=v; o.textContent=v; e.appendChild(o);
                });
            };
            fill('mass-est', 'ESTABLECIMIENTO');
            fill('mass-lote', 'LOTE');
            fill('mass-prod', 'PRODUCTO');
            fill('mass-productor', 'PRODUCTOR');
            document.getElementById('mass-destino').value = '';
            document.getElementById('mass-cp').value = '';
            document.getElementById('mass-edit-modal').classList.add('active');
        }
        function saveMassEdit() {
            const newEst = document.getElementById('mass-est').value;
            const newLote = document.getElementById('mass-lote').value;
            const newProd = document.getElementById('mass-prod').value;
            const newProductor = document.getElementById('mass-productor').value;
            const newDest = document.getElementById('mass-destino').value;
            const newCP = document.getElementById('mass-cp').value;

            state.data.forEach(row => {
                if (state.selectedRows.has(row.id)) {
                    if(newEst) row['ESTABLECIMIENTO'] = newEst;
                    if(newLote) row['LOTE'] = newLote;
                    if(newProd) row['PRODUCTO'] = newProd;
                    if(newProductor) row['PRODUCTOR'] = newProductor;
                    if(newDest) row['DESTINO DESCARGA'] = newDest;
                    if(newCP) row['CARTA DE PORTE'] = newCP;
                }
            });
            state.selectedRows.clear();
            document.getElementById('mass-edit-modal').classList.remove('active');
            applyFilters();
            alert("Registros actualizados.");
        }

        // --- 8. UTILS & OTHERS ---
        function initDropdown(id, key) {
            const wrapper = document.getElementById(id);
            if (!wrapper) return; 
            const opts = wrapper.querySelector('.custom-options');
            const trigger = wrapper.querySelector('.custom-select-trigger');
            const vals = [...new Set(state.data.map(d => d[key]))].filter(Boolean).sort();
            vals.forEach(v => {
                const d = document.createElement('div');
                d.className = 'option-item';
                d.innerHTML = `<input type="checkbox" value="${v}"> ${v}`;
                d.addEventListener('click', e => {
                    if(e.target.tagName !== 'INPUT') d.querySelector('input').checked = !d.querySelector('input').checked;
                    applyFilters();
                });
                opts.appendChild(d);
            });
            trigger.addEventListener('click', () => {
                document.querySelectorAll('.custom-options').forEach(o => o !== opts && o.classList.remove('open'));
                opts.classList.toggle('open');
            });
        }
        function initGroupByDropdown() {
            const wrapper = document.getElementById('group-by-select');
            const opts = wrapper.querySelector('.custom-options');
            const trigger = wrapper.querySelector('.custom-select-trigger span');
            const triggerDiv = wrapper.querySelector('.custom-select-trigger');
            const dims = [
                {key: 'DESTINO DESCARGA', label: 'Destino'}, {key: 'FECHA RECEPCION', label: 'Fecha'},
                {key: 'ESTABLECIMIENTO', label: 'Establecimiento'}, {key: 'LOTE', label: 'Lote'},
                {key: 'PRODUCTO', label: 'Producto'}, {key: 'PRODUCTOR', label: 'Productor'},
                {key: 'CONTRATISTA', label: 'Contratista'}, {key: 'TOLVA', label: 'Tolva'}
            ];
            dims.forEach(dim => {
                const d = document.createElement('div');
                d.className = 'option-item';
                d.innerHTML = `<input type="checkbox" value="${dim.key}"> ${dim.label}`;
                d.addEventListener('click', e => {
                    if(e.target.tagName !== 'INPUT') d.querySelector('input').checked = !d.querySelector('input').checked;
                    applyFilters(); updateGroupLabel(wrapper, trigger, triggerDiv);
                    state.isQuickGroupActive = false;
                    const btn = document.getElementById('btn-flash-toggle'); btn.classList.remove('active'); btn.innerHTML = '<i class="ph ph-stack-plus"></i> Agrupar Destinos';
                });
                opts.appendChild(d);
            });
            triggerDiv.addEventListener('click', () => { document.querySelectorAll('.custom-options').forEach(o => o !== opts && o.classList.remove('open')); opts.classList.toggle('open'); });
        }
        function updateGroupLabel(wrapper, trigger, triggerDiv) {
            const checked = Array.from(wrapper.querySelectorAll('input:checked'));
            if (checked.length === 0) { trigger.textContent = "(Sin Agrupar)"; triggerDiv.style.backgroundColor = "#fff"; }
            else { trigger.textContent = `${checked.length} Dimensión(es)`; triggerDiv.style.backgroundColor = "#dcfce7"; }
        }
        function toggleQuickGroup() {
            const wrapper = document.getElementById('group-by-select');
            const checkboxes = wrapper.querySelectorAll('input[type="checkbox"]');
            const btn = document.getElementById('btn-flash-toggle');
            if (state.isQuickGroupActive) {
                checkboxes.forEach(cb => cb.checked = false); state.isQuickGroupActive = false; btn.classList.remove('active'); btn.innerHTML = '<i class="ph ph-stack-plus"></i> Agrupar Destinos';
            } else {
                // ACTIVATE ALL DIMENSIONS
                checkboxes.forEach(cb => cb.checked = true);
                state.isQuickGroupActive = true; btn.classList.add('active'); btn.innerHTML = '<i class="ph ph-list-dashes"></i> Desagrupar';
            }
            applyFilters(); const trigger = wrapper.querySelector('.custom-select-trigger span'); const triggerDiv = wrapper.querySelector('.custom-select-trigger'); updateGroupLabel(wrapper, trigger, triggerDiv);
        }

        function openEditModal(id) { 
            const row = state.data.find(r => r.id === id); if(!row) return;
            const fill = (eid, k, s) => { 
                const e = document.getElementById(eid); e.innerHTML=''; 
                [...new Set(state.data.map(r=>r[k]))].sort().forEach(v=>{
                    const o=document.createElement('option'); o.value=v; o.textContent=v; if(v===s) o.selected=true; e.appendChild(o);
                });
            };
            document.getElementById('edit-index').value = id;
            document.getElementById('edit-fecha').value = row['FECHA RECEPCION'];
            document.getElementById('edit-kg').value = row['PESO HUMEDO Kg'];
            document.getElementById('edit-tolva').value = row['TOLVA'];
            fill('edit-est','ESTABLECIMIENTO',row['ESTABLECIMIENTO']);
            fill('edit-lote','LOTE',row['LOTE']);
            fill('edit-prod','PRODUCTO',row['PRODUCTO']);
            document.getElementById('edit-modal').classList.add('active');
        }
        function closeEditModal() { document.getElementById('edit-modal').classList.remove('active'); }
        function saveEdit() {
            const id = parseInt(document.getElementById('edit-index').value); const row = state.data.find(r => r.id === id);
            if(row) {
                row['ESTABLECIMIENTO'] = document.getElementById('edit-est').value;
                row['LOTE'] = document.getElementById('edit-lote').value;
                row['PRODUCTO'] = document.getElementById('edit-prod').value;
                row['TOLVA'] = document.getElementById('edit-tolva').value;
                applyFilters(); closeEditModal();
            }
        }
        function unlockField(fid) { if(prompt("Clave:")==='123') document.getElementById(fid).disabled=false; }
        
        // Profile
        function openProfileModal() { document.getElementById('prof-name').value=user.name; document.getElementById('prof-lastname').value=user.lastname; document.getElementById('prof-email').value=user.email; document.getElementById('prof-phone').value=user.phone; document.getElementById('profile-modal').classList.add('active'); }
        function saveProfile() { user.name=document.getElementById('prof-name').value; user.lastname=document.getElementById('prof-lastname').value; document.getElementById('header-username').textContent=`${user.name} (${user.lastname})`; document.getElementById('profile-modal').classList.remove('active'); }

        // Maps
        window.initMap = function() { map = new google.maps.Map(document.getElementById("google-map-container"), { zoom: 12, center: { lat: -32.0565, lng: -62.6908 }, mapTypeId: "satellite", streetViewControl: false }); };
        function openMapGlobal() { document.getElementById('map-modal').classList.add('active'); setTimeout(() => { if(map) { google.maps.event.trigger(map, "resize"); updateMapMarkers(state.filtered); } }, 300); }
        function openMapLocal(lat, lng) { 
            document.getElementById('map-modal').classList.add('active'); 
            setTimeout(() => { 
                if(map) { 
                    google.maps.event.trigger(map, "resize"); 
                    clearMarkers(); 
                    const m = new google.maps.Marker({ position: { lat: lat, lng: lng }, map: map, animation: google.maps.Animation.DROP }); 
                    mapMarkers.push(m); map.setCenter({ lat: lat, lng: lng }); map.setZoom(16); 
                } 
            }, 300); 
        }
        
        // Open Map for a Group (Multiple Points)
        function openMapGroup(index) {
            const group = state.groupedData[index];
            if(!group || !group.items) return;
            document.getElementById('map-modal').classList.add('active');
            setTimeout(() => {
                if(map) {
                    google.maps.event.trigger(map, "resize");
                    updateMapMarkers(group.items);
                }
            }, 300);
        }

        function updateMapMarkers(items) {
            clearMarkers(); const bounds = new google.maps.LatLngBounds(); let c=0; 
            items.forEach(r => { 
                if (!isNaN(r.LAT_NUM) && !isNaN(r.LNG_NUM) && r.LAT_NUM !== 0) { 
                    const pos = { lat: r.LAT_NUM, lng: r.LNG_NUM }; 
                    const m = new google.maps.Marker({ position: pos, map: map, title: r.ESTABLECIMIENTO, icon: r.IS_AUTO ? 'http://maps.google.com/mapfiles/ms/icons/green-dot.png' : 'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png' }); 
                    const info = new google.maps.InfoWindow({ content: `<b>${r.ESTABLECIMIENTO}</b><br>Destino: ${r['DESTINO DESCARGA']}<br>Hora: ${r['HORA RECEPCION']}<br>Tolva: ${r.TOLVA}<br>Peso: ${r.PESO_NUM}kg` }); 
                    m.addListener("click", () => info.open(map, m)); 
                    mapMarkers.push(m); bounds.extend(pos); c++; 
                } 
            }); 
            if(c>0) map.fitBounds(bounds); 
        }
        function clearMarkers() { mapMarkers.forEach(m => m.setMap(null)); mapMarkers = []; }
        function closeMap() { document.getElementById('map-modal').classList.remove('active'); }
        document.addEventListener('click', e => { if(!e.target.closest('.custom-select-wrapper')) document.querySelectorAll('.custom-options').forEach(o => o.classList.remove('open')); });
        
        init();
    </script>
</body>
</html>
